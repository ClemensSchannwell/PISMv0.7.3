% Copyright (C) 2004-2006 Jed Brown and Ed Bueler
%
% This file is part of Pism.
%
% Pism is free software; you can redistribute it and/or modify it under the
% terms of the GNU General Public License as published by the Free Software
% Foundation; either version 2 of the License, or (at your option) any later
% version.
%
% Pism is distributed in the hope that it will be useful, but WITHOUT ANY
% WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
% FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
% details.
%
% You should have received a copy of the GNU General Public License
% along with Pism; if not, write to the Free Software
% Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

\documentclass[12pt,final]{amsart}%default 10pt
%prepared in AMSLaTeX, under LaTeX2e
\addtolength{\topmargin}{-0.25in}
\addtolength{\textheight}{0.7in}
\addtolength{\oddsidemargin}{-0.7in}
\addtolength{\evensidemargin}{-0.7in}
\addtolength{\textwidth}{1.4in}
\newcommand{\normalspacing}{\renewcommand{\baselinestretch}{1.1}\tiny\normalsize}
\newcommand{\tablespacing}{\renewcommand{\baselinestretch}{1.0}\tiny\normalsize}
\normalspacing

\usepackage{amssymb,alltt,verbatim,natbib}
% check if we are compiling under latex or pdflatex
%\ifx\pdftexversion\undefined
  \usepackage[final,dvips]{graphicx}
%\else
%  \usepackage[final,pdftex]{graphicx}
%\fi

\theoremstyle{plain}
\newtheorem*{thm*}{Theorem}
\newtheorem*{question}{Question}
\newtheorem{thm}{Theorem}
\newtheorem{lem}{Lemma}
\newtheorem{claim}{Claim}
% \newtheorem{lem}[thm]{Lemma}  would put lemmas and thms in same seq.
%\newtheorem*{prop*}{Proposition}
\newtheorem{prop}{Proposition}
\newtheorem{cor}{Corollary}
\newtheorem{alg}{Algorithm}
\theoremstyle{definition}
\newtheorem*{defn}{Definition}
\newtheorem*{example}{Example}
\newtheorem{method}{Method}
\newtheorem{ass}{Temporary Assumption}
\theoremstyle{remark}
\newtheorem*{remark}{Remark}

% inclusion/figure macros
\newcommand{\mfigure}[1]{\includegraphics[height=3in,
keepaspectratio=true]{eqns3Deps/#1.eps}}
\newcommand{\bigmfigure}[1]{\includegraphics[height=4in,
keepaspectratio=true]{eqns3Deps/#1.eps}}
\newcommand{\regfigure}[2]{\includegraphics[height=#2in,
keepaspectratio=true]{eqns3Deps/#1.eps}}
\newcommand{\mtt}{\texttt}
\newcommand{\mfile}[1]
{\medskip\begin{quote}\scriptsize \begin{alltt}\input{C:/MATLAB6p5/work/icecodes/#1.m}\end{alltt} \normalsize\end{quote}\medskip}

% math macros
\def\complex{\mathbb{C}}
\newcommand{\DDt}[1]{\ensuremath{\frac{d #1}{d t}}}
\newcommand{\dd}[2]{\ensuremath{\frac{\partial #1}{\partial #2}}}
\newcommand{\ddt}[1]{\ensuremath{\frac{\partial #1}{\partial t}}}
\newcommand{\ddx}[1]{\ensuremath{\frac{\partial #1}{\partial x}}}
\newcommand{\ddy}[1]{\ensuremath{\frac{\partial #1}{\partial y}}}
\newcommand{\ddtp}[1]{\ensuremath{\frac{\partial #1}{\partial t'}}}
\newcommand{\ddxp}[1]{\ensuremath{\frac{\partial #1}{\partial x'}}}
\newcommand{\ddz}[1]{\ensuremath{\frac{\partial #1}{\partial z}}}
\newcommand{\dds}[1]{\ensuremath{\frac{\partial #1}{\partial s}}}
\newcommand{\dddxdx}[1]{\ensuremath{\frac{\partial^2 #1}{\partial x^2}}}
\newcommand{\dddsds}[1]{\ensuremath{\frac{\partial^2 #1}{\partial s^2}}}
\newcommand{\dddzdz}[1]{\ensuremath{\frac{\partial^2 #1}{\partial z^2}}}
\newcommand{\diverg}{\nabla\cdot}
\newcommand{\Div}{\diverg}
\def\eps{\epsilon}
\newcommand{\grad}{\nabla}
\newcommand{\ihat}{\mathbf{i}}
\def\image{\operatorname{im}}
\def\integers{\mathbb{Z}}
\newcommand{\ip}[2]{\ensuremath{\left<#1,#2\right>}}
\newcommand{\jhat}{\mathbf{j}}
\newcommand{\khat}{\mathbf{k}}
\newcommand{\nhat}{\mathbf{n}}
\def\lam{\lambda}
\def\lap{\triangle}
\def\real{\mathbb{R}}
\def\tr{\mathrm{tr}\,}
\newcommand{\Up}{\ensuremath{\operatorname{Up}}}
\def\volume{\operatorname{vol}}
\def\vf{\varphi}

% macros for this paper only
\newcommand{\hmin}{h_{\text{min}}}
\newcommand{\hmax}{h_{\text{max}}}
\newcommand{\Tpmp}{T_{\text{pmp}}}
\newcommand{\bG}{{\mathbf{G}}}
\newcommand{\bq}{{\mathbf{q}}}
\newcommand{\bQ}{{\mathbf{Q}}}
\newcommand{\bu}{{\mathbf{u}}}
\newcommand{\bU}{{\mathbf{U}}}
\newcommand{\bV}{{\mathbf{V}}}
\newcommand{\ufrac}[2]{\ensuremath{\frac{\text{#1}}{\text{#2}} }}


\begin{document}
\title[A 3D thermocoupled model for ice sheets]{A 3D thermocoupled model \\ for cold, shallow, multi-modal ice sheet flow}

\author[Bueler, Brown, and Lingle]{Ed Bueler$^1$, Jed Brown$^2$, Craig Lingle$^2$}

\date{\scriptsize \today.   $^1$Dept.~of Mathematics and Statistics, University of Alaska, Fairbanks AK 99775, $^2$Geophysical Institute, University of Alaska, Fairbanks AK 99775;  \emph{email}: \mtt{ffelb@uaf.edu}.  \textbf{THESE NOTES DESPERATELY NEED A THOROUGH REVISION!  (The ``Overview'' and the last section were recently revised.)}\normalsize}

\begin{abstract}  These notes describe a thermocoupled three-dimensional continuum model for shallow ice sheets.  They also describe some of the numerical methods which approximately solve the various partial differential equation problems of the model.  Note some problems are of free-boundary type.  These notes provide background documentation for the Parallel Ice Sheet Model  \citep{pism-web-page}.  They will be updated as PISM evolves, and are not intended for publication.\end{abstract}

\maketitle
\tablespacing
\setcounter{tocdepth}{1}
\tableofcontents


\newpage
\phantom{bob}
\vspace{2in}
\begin{quote}
\textsl{Copyright (C) 2004-2007 Jed Brown and Ed Bueler}
\medskip

\noindent \textsl{This file is part of PISM.}
\medskip

\noindent \textsl{PISM is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.}
\medskip

\noindent \textsl{PISM is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.}
\medskip

\noindent \textsl{You should have received a copy of the GNU General Public License along with PISM; if not, write to the Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA}
\end{quote}
\vspace{1in}
\normalspacing

\centerline{\textsc{Acknowledgements}}
\bigskip

We thank the NASA Cryospheric Sciences Program for supporting this research with grant NAG5-11371.  Dave Covey and Elena Sulemani were intimately involved with early versions of the numerical model, and we thank them for their contributions.  Martin Truffer has provided much-appreciated help with the physics of ice.


\newpage
\section{Overview}
Significant features of the continuum model approximated by the Parallel Ice Sheet Model  \citep[``PISM''; see][]{pism-web-page} and described in these notes include:\begin{itemize}
\item The inland ice sheet is modeled with the thermocoupled shallow ice approximation equations \citep{Fowler}, and some temperature-activated basal sliding is allowed.
\item Ice shelves and ice streams are modeled by shallow equations which describe flow by longitudinal strain rates and basal sliding; these equations are, of course, different from the shallow ice approximation.  In shelves and streams the velocities are independent of depth within the ice.  The equations were originally established for ice shelves \citep{Morland,MorlandZainuddin,MacAyealetal}.  They were adapted for ice streams, as ``dragging ice shelves,'' by \citet{MacAyeal}; see also \citep{HulbeMacAyeal}.
\item The regions of grounded ice in which the ice stream model is applied can be determined, in part, from mass balance velocities, for instance as reported in \citep{BamberVaughanJoughin} for Antarctica.  The regions could also be determined from observed surface velocities, supposing those represent a sufficiently complete set.
\item A three dimensional age field is computed.
\item Geothermal flux which varies in the map-plane is used, for instance based on the new Antarctic results in \citep{ShapiroRitzwoller} and \citep{FoxMaule}.
\item Within the shallow ice sheet regions the model can use the constitutive relation of Goldsby and Kohlstedt \citep{GoldsbyKohlstedt,Peltieretal}.  For inclusion in this flow law, grain size can be computed using a age-grain size relation from the Vostok core data \citep{VostokCore}, for example.
\item The \citet{LingleClark} bed deformation model is used.  It combines a spherical elastic earth and viscous half-space asthenosphere/mantle.  This model can be initialized by an observed bed uplift map \citep{BLKfastearth}, or even an uplift map computed by an external model.\end{itemize}

Many of the parts of the model described above are optional.  For instance, the Paterson-Budd-Glen \citep{PatersonBudd} flow can replace the Goldsby-Kohlstedt law, a simple isostasy model can be substituted for the more sophisticated one, and so on.  Options can be chosen at the command line when using PISM \citep{pism-web-page}.

The following features are \emph{not} included in the continuum model, and would (or will) require major additions:
\begin{itemize}
\item Inclusion of all components of the stress tensor (i.e.~longitudinal stresses within the shallow ice approximation region and additional shear stress components in shelves/streams) through either an intermediate order scheme \citep{Blatter,SaitoEISMINT} or the full Stokes equations.
\item A model for water--content within the ice.  In the current model the ice is \emph{cold} and not \emph{polythermal} \citep[compare][]{Greve}.  On the other hand, in the current model the energy used to melt the ice within a given column, if any, is conserved.  In particular, a layer of basal melt water evolves by conservation of energy in the column.  This layer can activate basal sliding and its latent heat energy is available for refreezing.
\item A model for basal water mass conservation in the map-plane \citep[compare][]{JohnsonFastook}.
\item A fully spherical Earth deformation model, for example one descended from the Earth model of \citet{Peltier}.
\end{itemize}

Significant features of the numerical method described in these notes and implemented in PISM, include:\begin{itemize}
\item Verification \citep{Roache} is a primary concern and is built into the code.  Nontrivial verifications are available for isothermal ice sheet flow \citep{BLKCB}, thermocoupled sheet flow \citep{BB,BBL}, the earth deformation model \citep{BLKfastearth}, the coupled (ice flow)/(earth deformation) system in an isothermal and pointwise isostasy  case \citep{BLKfastearth}, and the MacAyeal equations for ice stream flow \citep{BrownPresentation}.
\item The code is \emph{structurally} parallel.  In fact, the PETSc toolkit is used at all levels \citep{petsc-web-page,petsc-user-ref}.  PETSc manages the MPI-based communication between processors, and provides an interface to parallel numerical linear algebra and other numerical functions.
\item A moving boundary technique is used for the temperature equation which does not stretch the vertical in a singular manner; the Jenssen \citep{Jenssen} change of variables is not used.
\item The model uses an explicit time stepping method for flow and a partly implicit method for temperature.  Advection of temperature is upwinded \citep{MortonMayers}.  As described by  \citet{BBL}, reasonably rigorous stability criteria are applied to the time-stepping scheme, including the diffusivity-based criteria for the explicit mass continuity scheme and the CFL criteria \citep{MortonMayers} for temperature advection.  The local truncation error is $O(\Delta x,\Delta y,\Delta z,\Delta t)$.
\item The equations to determine velocity in the ice shelf and ice stream regions are solved by a finite difference method which computes a nonlinear iteration of a Krylov subspace method implemented in PETSc \citep{BrownPresentation,petsc-web-page,petsc-user-ref}.
\item The bed deformation model is implemented by a new Fourier collocation (spectral) method \citep{BLKfastearth}.
\item Implementation is in C++ and is object-oriented.  For example, verification occurs in a derived class.
\end{itemize}


\newpage
\section{The mathematical model}
\label{mathmodelsect}
\subsection*{Notation}  The overall domain $\mathcal{D}$ is a rectangular region $(x,y,z)\in [-L_x,L_x]\times [-L_y,L_y]\times([\text{bed}_{\text{min}},H_{\text{max}}]$, $t\ge 0$.  Note that the part of the vertical interval, namely $[\text{bed}_{\text{min}},0]$, where $\text{bed}_{\text{min}} \le 0.0$, is within the bedrock.  Note $z$ increases as one goes away from the center of the geoid.

The model is runs forward in time from an inital time $t_0$.  The following functions are required to initialize the model:
\begin{align*}
&b(x,y,t_0) &&\text{initial bed elevation (m)}; \\
&H(x,y,t_0) &&\text{initial ice thickness (m)};\\
&T(x,y,z,t_0) &&\text{initial (absolute) ice temperature (K)}.
\end{align*}

The following functions are sources for the model:
\begin{align*}
&G(x,y,t) &&\text{geophysical heat flux at base of ice (W/$\text{m}^2$)};\\
&M(x,y,t) &&\text{ice--equivalent accumulation/ablation in the map-plane (m/a)};\\
&T_s(x,y,z,t) &&\text{surface air temperature (K)}.
\end{align*}

The functions which are approximated by the model, and which are outputs from the model, are:
\begin{align*}
&b(x,y,t) &&\text{bed elevation (m)}; \\
&h(x,y,t) &&\text{ice surface elevation (m)};\\
&H(x,y,t) &&\text{ice thickness (m)};\\
&S(x,y,t) &&\text{basal melt rate (m/s);}\\
&T(x,y,z,t) &&\text{(absolute) ice and bedrock temperature (K)};\\
&\tau(x,y,z,t) &&\text{age of the ice (a)};\\
&\bu=u\ihat+v\jhat+w\khat &&\text{horizontal velocity (m/a);}\\
&&& \text{[components depend on } x,y,z,t];\\
&\bU_b=u_b\ihat+v_b\jhat &&\text{horizontal velocity at the bed (m/a);}\\
&&& \text{[components depend on } x,y,t].
\end{align*}
Thickness, surface elevation and bed topography are, of course, related by $h=H+b$ when the ice is grounded, while $h = (1-\rho_{\text{ice}}/\rho_{\text{water}}) H$ for floating ice.

Physical constants appear in the text below.  Their values and units are given at the end of this paper.  A more complete index of notation [FIXME: COULD BE] given at the end of this paper.

Partial derivatives are denoted $\frac{\partial f}{\partial x}$, etc.  Subscripts are used (in particular) for directions, as in $\sigma_{xy}$ and $\sigma_{ij}$ for specific and generic components of the stress tensor, respectively.  Vector notation uses the standard unit vectors $\ihat$, $\jhat$, $\khat$; bold denotes vectors.  Gradient and divergence notation will be used, but exclusively in the horizontal directions, as in
    $$\grad f = \ddx{f} \ihat + \ddy{f} \ihat, \qquad \qquad \diverg \bU = \ddx{u} + \ddy{v}$$
if $\bU=u\ihat+v\jhat$.


\subsection*{Equations of the shallow ice approximation}  The continuity equation for ice \citep{Paterson}, which we think of as the main flow partial differential equation, is
\begin{equation}\label{Cfirst}
\ddt{H} = M - S - \diverg \bQ.
\end{equation}
By definition, $\bQ$ is the horizontal ice flux
\begin{equation}\label{flux}
\bQ = \int_{b}^h \bU\,dz = \bar \bU H,
\end{equation}
and $\bar \bU$ is the depth--averaged horizontal velocity.

In what follows we denote by $\sigma_{ij}$ the full stress tensor, $\sigma_{ij}'= \sigma_{ij}- \frac{1}{3} \delta_{ij} \sigma_{kk}$ the deviatoric stress tensor, $\sigma'= \left(\sigma_{ij}' \sigma_{ij}'\right)^{1/2}$  the effective shear stress, and
    $$\dot \eps_{ij} = \frac{1}{2} \left(\dd{u_i}{x_j} + \dd{u_j}{x_i}\right)$$
the strain rate tensor.  Both $\sigma_{ij}$ and $\dot \eps_{ij}$ are symmetric tensors.

In the shallow ice approximation \citep{Fowler} $\bU$ is a vertical integral of the horizontal shear strain rates because $\dot \eps_{xx},\dot \eps_{yy},\dot \eps_{zz},\dot \eps_{xy}$ are all assumed to be negligibly small, and s0
\begin{equation}\label{stressstrain}
\ddz{\bU} = 2(\dot\eps_{xz}\ihat+\dot\eps_{yz}\jhat).
\end{equation}
It follows that $\bU=\int 2(\dot\eps_{xz}\ihat+\dot\eps_{yz}\jhat)\, dz$.

It is supposed for ice sheet, stream, and shelf flow that the ice is purely viscous, that is, that it has no recoverable elastic response to forces.  The strain rates depend directly on the deviatoric stresses, that is, the material is viscous \citep{Fowler}.  This dependence is described by a nontrivial constitutive relation, however, because the viscous behavior is non-Newtonian \citep{Paterson}.  This relation also significantly involves the temperature \citep{Paterson}.  We also allow dependence on pressure.  We assume, however, that the flow of ice is isotropic \citep{Paterson}.  The constitutive relation is therefore taken to have the form
\begin{equation}\label{constitutive}
\dot\eps_{ij}=F(T,\sigma',P)\,\sigma_{ij}'.
\end{equation}
The possible \emph{constitutive function} $F$ are discussed in detail in the next section.  Here $T$ is the temperature and $P$ is the pressure.  This relation incorporates Nye's generalization \citep{Nye} of the \citet{Glen} flow law, even if the function $F$ is not given by Glen's power law form.  Regarding the interpretation of this law, note that if $\sigma_{ij}'=2\nu \dot\eps_{ij}$ for some function $\nu$ then $\nu$ is the \emph{effective viscosity}.  Thus $F$ is an inverse viscosity \citep{Fowler}.  Note
\begin{equation}\label{pressure}
P(x,y,z,t)=\rho g (h(x,y,t)-z),
\end{equation}
the hydrostatic pressure, is the assumed pressure at elevation $z$ above the bed in the shallow ice approximation.  Here $\rho$ is the density of ice and $g$ is the acceleration of gravity.

The shallow ice approximation in particular supposes that \citep{Fowler}
\begin{equation}\label{stressatdepth}
\sigma_{xz}' \ihat + \sigma_{yz}' \jhat = -P\grad h.
\end{equation}
These are the only nonnegligible components of the deviatoric stress tensor $\sigma_{ij}'$.  The corresponding effective shear stress is therefore
\begin{equation}\label{effstress}
\sigma' = |\sigma_{xz}' \ihat + \sigma_{yz}' \jhat| = P \alpha
\end{equation}
where $\alpha$ is the surface slope
    $$\alpha = |\grad h| = \left(\left|\ddx{h}\right|^2 + \left|\ddy{h}\right|^2\right)^{1/2}.$$
It follows that
\begin{equation}\label{ss}
\ddz{\bU}=-2 F(T,P\alpha,P) P \grad h.
\end{equation}

Equation \eqref{ss}, which combines \eqref{stressstrain}, \eqref{constitutive} and \eqref{stressatdepth}, is the essential practical equation of the shallow ice approximation.  It says that ice flow is locally determinable only by horizontal shear stresses which are completely determined by pressure (i.e., depth), surface gradient, and temperature.


\subsection*{The stress--strain constitutive relation}\label{Fsubsect}  The function $F$ appearing in the constitutive relation \eqref{constitutive} adopts several forms in the literature but the traditional form is separated:
\begin{equation}\label{tradF}
F(T,\sigma,P)=A(T^*) f(\sigma).
\end{equation}
Here $T^*$ is the homologous temperature
    $$T^*(x,y,z,t) = T(x,y,z,t) - P(x,y,z,t) \Phi,$$
where $\Phi$ is the constant rate of change of melting point with pressure \citep{PayneBaldwin}.  That is, $T^*$ is the absolute temperature shifted by pressure.\footnote{Recalling \eqref{pressure}, $T^*=T-\rho g (h-z) \Phi$ in the shallow ice approximation.  If $T_0$ is the triple point of water, $\Tpmp = T_0 - \rho g \Phi (h-z)$ is the \emph{pressure-melting temperature} at depth $h-z$ in the ice. One may combine constants and write $T^* = T - \beta (h-z)$ where $\beta = \rho g \Phi$; in PISM we use $\beta = 8.66\times 10^{-4}$ K/m.}

We consider this separated form first, and then reconsider $F$ in light of work by Goldsby and Kohlstedt \citep{GoldsbyKohlstedt}.  Note that in the separated form there is dependence on the pressure $P$ through equation \eqref{stressatdepth} for $\sigma$ and through the formula for homologous temperature $T^*$.

The most common separated form is Glen's flow law \citep{Glen}
    $$f(\sigma)=\sigma^{n-1}$$
where $n=3$ is the default Glen value; alternatively $f(\sigma)$ could be a more general polynomial law \citep{Hutter93}.

The ``flow factor'' or ``softness parameter'' $A(T^*)$ appears in the literature in two best known forms.  Hooke \citep{Hooke} says
    $$A(T^*) = A_0 \exp\left(\frac{-Q}{R T^*} + \frac{3c}{(T_r - T^*)^\kappa}\right)$$
and Paterson and Budd \citep{PatersonBudd} say
\begin{equation}\label{PatBuddArr}
A(T^*) = \begin{cases} a_1 \exp\left[-Q_1/(R T^*)\right], &T^*<263 \text{ K} \\
a_2 \exp\left[-Q_2/(R T^*)\right], &T^*\ge 263 \text{ K} \end{cases}.
\end{equation}
Figure \ref{arrfig} below compares these two relations in the relevant range\footnote{I believe this corrects figure 5 of \citep{PayneBaldwin}, and actually shows the phenomenon referred to there: ``The apparent discontinuity in the Hooke relationship near 273 K is due to the sampling interval used to plot this curve.  The relationship is, in fact, continuous throughout.''}.  A further important option in any simulation is the isothermal choice, that is $A(T^*)\equiv A_0$.  Note that the \emph{EISMINT} isothermal benchmark \citep{EISMINT96} value of $A_0=10^{-16}$ $\text{Pa}^{-3}$ $\text{a}^{-1}$ corresponds to fairly warm ice in either of the $A(T^*)$ models just mentioned.
\begin{figure}[ht]
\regfigure{arrfig}{3}
\caption{Comparison of \citet{Hooke} and \citet{PatersonBudd} Arrhenius relations.}
\label{arrfig}
\end{figure}

Now, the separated form \eqref{tradF} for $F$ is undoubtedly a simplification.  Indeed Goldsby and Kohlstedt \citep{GoldsbyKohlstedt} have introduced an improved form based on further experiment and compilation of older data.  They propose
\begin{equation}\label{GKF}
F(T,\sigma,P)=F_{\text{\emph{diff}}} + \left(F_{\text{\emph{basal}}}^{-1} + F_{\text{\emph{gbs}}}^{-1}\right)^{-1} +F_{\text{\emph{disl}}}.
\end{equation}
Three of these terms, namely  $F_{\text{\emph{basal}}}, F_{\text{\emph{gbs}}}, \text{ and } F_{\text{\emph{disl}}}$, satisfy a rule of modified Arrhenius--Glen form (compare \eqref{tradF}):
    $$F_{\#}=A_{\#} \frac{\sigma^{n_{\#}-1}}{d^p} \exp\left(-\frac{Q_{\#}+PV}{RT}\right).$$
The constants $A_{\#},n_{\#},Q_{\#}$ are given values in table 5 of \citep{GoldsbyKohlstedt} and differ for the three cases.  Note $A_{\#},Q_{\#}$ in fact depend on ranges of $T$, as in the Paterson--Budd relation \eqref{PatBuddArr} above.  The constants $p, V, R$ are all actually constant.  The remaining term $F_{\text{\emph{diff}}}$ is determined by a rule of a different form given by equation (4) in \citep{GoldsbyKohlstedt} with constants determined by table 6 in \citep{GoldsbyKohlstedt}.

It would seem that either the grain size $d$ must be approximated by an additional yet--to--be--determined model equation or it must be assumed constant.  The latter strategy is adopted in this paper.


\subsection*{Horizontal velocity in the shallow ice approximation}\label{ss:horvel}  Equation \eqref{ss} can be integrated to express the horizontal velocity as a vertical integral:
    $$\bU(z) = - 2 \grad h \int_{b}^z F(T(\zeta),\sigma(\zeta),P(\zeta)) P(\zeta)\,d\zeta + \bU_b.$$
where $F$ is the constitutive relation discussed above.  Here $\bU_b=\bU(z=b)$ is the horizontal velocity at the base of the ice sheet.

Dependence on $x,y,t$ is suppressed in the majority of the remaining model description, and $\zeta$ plays the role of $z$ as a dummy variable of integration.  We have integrated from the base because we plan to use a basal sliding model which will determine $\bU_b$ as a function of the basal effective shear stress and temperature.\footnote{On the other hand, \emph{surface} velocities of real ice sheets are, with current experimental means, well--known compared to the basal velocities.}

Recalling that the flux $\bQ$ is the vertical integral of $\bU$, the equation
\begin{equation}\label{iceFourier}
\bQ = - D\grad h + \bU_b H,
\end{equation}
defines a scalar ``diffusivity'' $D$ \citep{vanderVeen} as follows.  Equation \eqref{iceFourier} is essentially ``Fourier's law'' for ice flow, that is, the flux is proportional to the gradient of the height, though the proportionality depends on both thickness and surface slope.  From \eqref{flux} and the above equation for $\bU$,
\begin{align}\label{diffint}
D(x,y,t) &= 2 \int_{b}^h \int_{b}^z F(\zeta) P(\zeta)\,d\zeta\,dz = 2 \int_{b}^h F(z)P(z)(h-z)\,dz,
\end{align}
where $F(z)=F(T,\sigma,P)$ at depth $z$.  The order of integration can be changed, as shown, so as to eliminate one integral.

\begin{example} If one uses \eqref{diffint}, the Glen flow law $f(\sigma)=\sigma^{n-1}$, and if one supposes a constant temperature to determine $A_0=A(T^*)$, then one finds:
    $$D=2(\rho g)^n A_0 \alpha^{n-1} \int_{b}^h (h-z)^{n+1}\,dz=\frac{2(\rho g)^n A_0}{n+2} \alpha^{n-1} H^{n+2}. \qquad [\text{isothermal, Glen}]$$
Thus
\begin{equation}\label{fluxiso}
\bQ=-\frac{2(\rho g)^n A_0}{n+2} \alpha^{n-1} H^{n+2} \, \grad h + \bU_b H, \qquad [\text{isothermal, Glen}]\end{equation}
a familiar expression from the \emph{isothermal} shallow ice approximation with Glen flow law \citep{EISMINT96,Paterson}.  Of course, we will not use equation \eqref{fluxiso} in the thermocoupled model of this paper.\end{example}

With $D$ given by \eqref{diffint}, the ice continuity equation \eqref{Cfirst} becomes a nonlinear diffusion equation
\begin{equation}\label{Cdiffform}
\ddt{H} = a + \diverg \left(D \grad h -\bU_b H\right).
\end{equation}
This will be regarded as the primary equation of flow.

It is convenient (and probably only that) to further simplify these expressions by introducing the ``local diffusivity rate per change in depth''
    $$\delta = 2 F(T,\sigma,P) P.$$
Note $\delta=\delta(x,y,z,t)$.  With this $\delta$, equation \eqref{ss} becomes simply
    $$\ddz{\bU} = - \delta \, \grad h.$$
From expressions \eqref{pressure} for $P$ and \eqref{effstress} for $\sigma$, $\delta$ is determined by temperature, depth and surface slope.  Simplified forms using $\delta$ are
\begin{equation}\label{UDsimp}
  \bU(z) = - \grad h \int_{b}^z \delta(\zeta) \,d\zeta + \bU_b \quad \text{ and } \quad D = \int_{b}^h \delta(z) (h-z) \,dz
\end{equation}
where $x,y,t$ dependence has been suppressed.

Vertical integrals of the type which determine $\bU$ and $D$ are computed many times in the ice model of the current paper.  Therefore we introduce yet more simplified notation:  Let
    $$I(z)=\int_b^z \delta(\zeta)\,d\zeta \quad \text{ and } \quad J(z)=\int_b^z \delta(\zeta)(z-\zeta)\,d\zeta.$$
Then $\bU(z)=-I(z)\grad h + \bU_b$ and $D=J(h)$.


\subsection*{Incompressibility and the vertical velocity}\label{incompsubsect}  Next, ice is incompressible:
\begin{equation}\label{incomp}
\diverg \bU + \ddz{w}=0.
\end{equation}
By integration we get useful expressions for the vertical velocity $w$ in terms of the essential depth--dependent quantity $\delta$, or equivalently in terms of $F$.  ``Expression\emph{s}'' because there is a choice of boundary condition, as follows.

Let $w_b(x,y,t)=w\big|_{z=b}$, $w_h(x,y,t)=w\big|_{z=h}$, $\bU_h(x,y,t)=\bU\big|_{z=h}$.  On the one hand, if $S$ is the rate of basal melting then \citep{PayneDongelmans}
\begin{equation}\label{wbasekine}
w_b=\ddt{b}+ \bU_b\cdot\grad b - S.
\end{equation}
On the other hand, at the surface of the ice there is a ``surface kinematical condition''\footnote{Whichever of \eqref{wbasekine} or \eqref{wsurfkine} is used as a boundary condition for velocity integrals, it is appropriate to check the other as a diagnostic.}
\begin{equation}\label{wsurfkine}
w_h=\ddt{h}+ \bU_h\cdot\grad h - M.
\end{equation}

Condition \eqref{wbasekine} plus incompressibility yields:\footnote{To derive \eqref{wintbase} and \eqref{wintsurf} one uses the differentiation rule for vector--valued $\bG$
    $$\int_{g(x,y)}^{h(x,y)} \diverg \bG(x,y,\zeta)\,d\zeta = \diverg \left(\int_{g}^{h} \bG \,d\zeta\right)- \bG(x,y,h)\cdot \grad h + \bG(x,y,g)\cdot \grad g.$$
Recall that $\diverg$ and $\grad$ involve only $x,y$ derivatives.}
\begin{align}\label{wintbase}
w(z) &= -\int_{b}^z \diverg \bU(\zeta)\,d\zeta + w_b
= - \diverg\left(\int_{b}^z\bU(\zeta)\,d\zeta\right) - \bU_b\cdot\grad b +w_b \notag\\
&=+ \diverg\left(J(z) \grad h\right) - \diverg (\bU_b(z-b)) + \ddt{b} - S.
\end{align}
Equation \eqref{UDsimp} for $\bU$ has been incorporated and an integral calculation like that in \eqref{diffint} has been performed.  Condition \eqref{wsurfkine} plus incompressibility yields:
\begin{align}
w(z) &= +\int_{z}^h \diverg \bU(\zeta)\,d\zeta + w_h = + \diverg\left(\int_{z}^h\bU(\zeta)\,d\zeta\right) - \bU_h\cdot\grad h +w_h\notag\\
&= - \diverg\left(\grad h \int_{z}^h \int_b^\zeta \delta(\zeta')\,d\zeta'\,d\zeta\right) + \diverg\left(\int_{z}^h\bU_b(\zeta)\,d\zeta\right) - \bU_h\cdot\grad h +w_h \notag\\
\label{wintsurf}&= - \diverg\left(\left[(h-z)I(z) + \int_{z}^h\delta(\zeta)(h-\zeta)\,d\zeta\right] \grad h\right) + \diverg\left(\bU_b(h-z)\right) + \ddt{h} - M.\end{align}

Equation \eqref{wintbase} is used in the current paper and model to determine the vertical velocity.


\subsection*{Basal sliding and basal melt rate}\label{basalsubsect}  Under those parts of the sheet where the temperature is below the pressure melting point $\Tpmp$, there is a simple basal sliding law, namely no sliding:
    $$\bU_b(x,y,t)=0 \qquad \text{if} \qquad T^*(z=b)< \Tpmp(H).$$
At locations where the basal temperature is at the melting point, some sliding model is needed.

Supposing the ice sheet is underlain by a viscous till layer of thickness $H_t$ and viscosity $\nu_t$ \citep{LingleTroshina,MacAyeal}, the simplest model is the linear law
    $$\bU_b(x,y,t)=+\left(\frac{H_t}{\nu_t}\right) \left(\sigma_{xz}'\ihat+\sigma_{yz}'\jhat\right) = - \left(\frac{H_t \rho g}{\nu_t}\right)  H \grad h$$
if $T^*(z=b)=\Tpmp(H)$.

Recall that boundary condition \eqref{wbasekine} for the vertical velocity in theory requires the calculation of a melt rate $S$ which has units of velocity.  [DESCRIBE BASAL MELT RATE COMPUTATION]
This quantity contributes to the vertical velocity in equation \eqref{wbasekine}.


\subsection*{The temperature model}\label{ss:temp}   We approximate in this paper the time evolution of the temperature of the ice, but the extent of the ice changes in all three spatial dimensions.  Thus the temperature field therefore solves a \emph{free boundary} problem as shown in figure \ref{tempbdry}.

\begin{figure}[ht]
\vspace{-3mm}
\regfigure{tempbdryfig}{3}
\vspace{-6mm}
\caption{Temperature solves a free boundary problem with both upper and lower moving surfaces.}
\label{tempbdry}
\end{figure}

Within the ice the temperature field $T$ is modelled by the equation
\begin{equation}\label{Teqn}
\ddt{T} + \bU\cdot \grad T + w \ddz{T} = \frac{k}{\rho c_p} \dddzdz{T}+ \Sigma.
\end{equation}
See \citep{Fowler,Paterson,vanderVeen} for derivation of this equation.  The left side is the ``material derivative'' and includes convection (advection).  The right side includes vertical conduction (diffusion) and a heat source.  The heat source $\Sigma$ is dissipation from the horizontal strain rate.  It is given by \citep{Paterson}
    $$\Sigma = \frac{\sigma}{\rho c_p} \left|\ddz{\bU}\right| = \frac{2}{\rho c_p} F(T,\sigma',P) \, \sigma'^{\,2}.$$
If a Glen type constitutive relation $F$ is used then $\Sigma$ is proportional to the $n+1$ power of the effective shear stress $\sigma'$ and thus is relatively singular for numerical approximation.   (We will return to this issue in later sections.)

A more complete model would, among other things,  include an accounting for the water content of that part of the ice which is at the melting point.  For ice sheets this is a small fraction of the total volume and may have only a small effect on flow \citep{Greve}.  We will not include such a model here.

However, ice which has reached the pressure melting temperature cannot easily be warmed further and so we augment the temperature equation with the condition
    $$\ddt{T^*}=0$$
at any point in the ice where
    $$T^*=\Tpmp \quad \text{ \emph{and} } \quad -\bU\cdot\grad T - w \ddz{T} + \frac{k}{\rho c_p} \dddzdz{T} + \Sigma - \rho g \Phi \ddt{h} \ge 0.$$
The ugly inequality condition follows from requiring that $T^*$ not increase once $\Tpmp$ is reached and from $\ddt{T^*}=\ddt{T}-\rho g \Phi \ddt{h}$.  In this model the ice is able to cool once the heating terms are no longer producing net heating---recall that advection and conduction can cool, of course.  In practical implementation this condition will be enforced as the temperature equation is solved and thus most of the terms in the inequality condition will already be available at each grid point.


\subsection*{Age}  The scalar age equation is purely advective.  In fact, it says that the material derivative of the age is $1$:
\begin{equation}\label{ageeqn}
\ddt{\tau} + \bU\cdot \grad \tau + w \ddz{\tau} = 1
\end{equation}
The numerical techniques which apply to the advection part of the temperature equation, for example upwinding, apply equally to the age equation.


\subsection*{Boundary conditions}  This completes the list of the primary physical (field) equations.  Now for the boundary conditions, which are presumed sufficient to produce exactly one solution to the whole system.\footnote{The existence and uniqueness of solutions to the thermocoupled system has not been proven.  The corresponding result for the isothermal case is proven in \citep{CDDSV}.}

The boundary condition applicable to the ice continuity equation is, I think,
    $$H\ge 0.$$
This requires some interpretation.  On the one hand, if $H=0$ at some point $(x,y)$ and time $t$ then the ice continuity equation \eqref{Cfirst} reduces to $\ddt{H} = \max\{a,0\}$.  On the other hand we must have some procedure for determining how the margin moves in regions where $a<0$.  That it does so is a consequence of \emph{flow}, of course.  At the level of a discretized model, there is a relatively well--known mechanism where a new, proposed value of $H$ is computed at every (horizontal) grid point, from \eqref{Cfirst}, and if the proposed value is negative $H<0$ then at the next time step the value of $H$ is set to zero.  This mechanism is alluded to in \citep{vanderVeen} and tested in \citep{BLKCB}.

We expect that for a grounded margin $Q$ should be continuous across the margin (i.e.~at the $H=0$ free boundary).  The condition at calving fronts and grounding lines where the ice sheet couples to an ice shelf is more complicated, and may include discontinuous $Q$ as a first approximation.

Boundary conditions for the velocities $\bU$, $w$ have already been addressed.

Boundary conditions for temperature $T$ occur at the moving $z=h$ and (potentially moving) $z=b$ boundaries.  In particular, an input to the model is the upper surface temperature
    $$T\big|_{z=h} = T_s.$$
At the base, since we are not modelling water content, we have a purely Neumann condition \citep{Huybrechts90}
\begin{equation}\label{tempbasecond}
k\ddz{T}\Big|_{z=b} = -G -\bU_b\cdot(\sigma_{xz}\ihat + \sigma_{yz}\jhat) = -G+\rho g H \bU_b\cdot \grad h
\end{equation}
where $G$ is the geothermal heat flux and the second term is a heating rate from sliding.

\newcommand{\bUb}{{\mathbf{U}_b}}
\newcommand{\alphaav}{{\alpha_{\text{av}}}}
\newcommand{\Dav}{{D_{\text{av}}}}
\newcommand{\deltaav}{{\delta_{\text{av}}}}
\newcommand{\bUav}{{\mathbf{U}_{\text{av}}}}
\newcommand{\bUbav}{{\mathbf{U}_{b,\text{av}}}}
\newcommand{\wav}{{w_{\text{av}}}}
\newcommand{\hav}{{h_{\text{av}}}}
\newcommand{\sigmaav}{{\sigma_{\text{av}}}}
\newcommand{\alphatemp}{{\alpha_{\text{temp}}}}
\newcommand{\wtemp}{{w_{\text{temp}}}}
\newcommand{\deltatemp}{{\delta_{\text{temp}}}}
\newcommand{\htemp}{{h_{\text{temp}}}}
\newcommand{\Htemp}{{H_{\text{temp}}}}
\newcommand{\gradhtemp}{{\grad h_{\text{temp}}}}
\newcommand{\Itemp}{{I_{\text{temp}}}}
\newcommand{\Jtemp}{{J_{\text{temp}}}}
\newcommand{\Dtemp}{{D_{\text{temp}}}}
\newcommand{\sigmatemp}{{\sigma_{\text{temp}}}}
\newcommand{\bUbtemp}{{\mathbf{U}_{b,\text{temp}}}}
\newcommand{\Dold}{{D_{\text{old}}}}

\subsection*{A change of vertical variable}  We make a change of the independent variable $z$ which simplifies the free boundary problem for temperature in case of nonflat or even moving bed.

Let
    $$s=z-b(x,y,t),$$
and make the change of variables $(x,y,z,t)\mapsto (x,y,s,t)$.  This replaces $z=b$ by $s=0$ as the equation of the base surface of the ice.  Therefore, with the change $z\to s$, the free boundary problem for temperature changes to involve only a free upper surface as shown in figure \ref{stempbdry}.

\begin{figure}[ht]
\vspace{-2mm}
\regfigure{stempbdryfig}{3}
\vspace{-4mm}
\caption{In $(x,y,s)$ space temperature solves a free boundary problem in which only the upper surface $s=H(x,y,t)$ moves.  Compare to figure \ref{tempbdry}.}
\label{stempbdry}
\end{figure}

[FIXME: NEEDED GENERALIZATION:  When floating, replace ``$b$'' with ``$-(\rho_i/\rho_o) H$''.]

Note that the region $\mathcal{R}=\left\{(x,y,s)\big| -L_x\le x \le L_x, -L_y\le y \le L_y, 0\le s \le s_{max}\right\}$ will be divided into a fixed three dimensional finite difference grid.  See section \ref{numsect}.

The change $z\to s$ \emph{is not} the Jenssen \citep{Jenssen} change of variable $s=\frac{z-b}{H}$ which causes the temperature equation to become singular at the boundaries of the ice sheet.  In fact, such a change replaces the vertical conduction term in the temperature equation \eqref{Teqn} by a manifestly singular term (supposing $H=0$ anywhere in the horizontal computational domain):
    $$\frac{k}{\rho c_p} \frac{\partial^2 T}{\partial z^2} = \frac{1}{H^2} \frac{k}{\rho c_p} \frac{\partial^2 T}{\partial s^2}.$$
A singular coefficient of this type affects the stability of all time-stepping schemes, including the putatively ``unconditionally stable'' schemes which are not actually stable for the coupled and nonlinear system.  The current change $s=z-b$ has no such singularizing effect though the change does result in added advection terms in the temperature equation.  Of course, there is still a free boundary to deal with numerically.

Recall that if $f=f(x,y,z,t)$ in the old variables and if $\tilde f(x,y,s,t)=f(x,y,z(x,y,s,t),t)$ is the ``same function written in the new variables'' (an equivalent relation is $f(x,y,z,t)=\tilde f(x,y,s(x,y,z,t),t)$) then
    $$\ddx{f} = \ddx{\tilde f}+\dds{\tilde f}\ddx{s} = \ddx{\tilde f}-\dds{\tilde f}\ddx{b}.$$
Similar replacements apply to $\ddy{f},\ddt{f}$. Note $\ddz{f}=\dds{\tilde f} \ddz{s} = \dds{\tilde f}$.

The following table records the important changes:
$$\begin{array}{ll}
\textbf{old} & \textbf{new} \\
P=\rho g(h-z) \phantom{dlksaflkdjflajsddlksaflkdjflaj} & P=\rho g(H-s) \phantom{dlksaflkdjflajsddlksaflkdjflaj} \\
I(z)=\int_b^z\delta(\zeta)\,d\zeta & I(s) = \int_0^{s} \delta(s')\,ds' \\
J(z)=\int_b^z\delta(\zeta)(z-\zeta)\,d\zeta & J(s) = \int_0^{s} \delta(s')(s-s')\,ds' \\
\bU(z)=-I(z)\grad h + \bU_b & \bU(s)=-I(s)\grad h+ \bU_b \\
D=J(h) & D=J(H) \\
%\end{array}$$
%$$\begin{array}{ll}
\ddt{T} & \ddt{T}-\dds{T}\ddt{b} \\
\grad T & \grad T- \dds{T}\grad b \\
\ddt{T}+\bU\cdot\grad T + w\ddz{T}=\frac{k}{\rho c_p} \dddzdz{T} + \Sigma & \ddt{T}+\bU\cdot\grad T + \left(w-\ddt{b}-\bU\cdot\grad b\right)\dds{T} \\
 & \qquad =\frac{k}{\rho c_p} \dddsds{T} + \Sigma \\
w(z)=\diverg \left(J(z)\grad h-(z-b)\bU_b\right)+\ddt{b}-S\qquad & w(s)=\diverg \left(J(s)\grad h-s\bU_b\right) \\
 & \qquad-\left(I(s)\grad h-\bU_b\right)\cdot\grad b + \ddt{b}-S.
\end{array}$$
%\vfill


\newpage
\section{Computations for each time step: a summary}

This section is essentially a table which summarizes the time stepping procedure.  One enters this sequence knowing the functions $h$, $T$, $b$, and $\ddt{b}$ at time $t=t_l$.  The number under ``\textbf{Time}'' indicates what time to associate with the computed quantity(ies).  The number under ``\textbf{Dim}'' indicates whether the computed quantity represents values on a $x,y$ grid (``2'' for 2D) or a $x,y,z$ grid (``3'').  Generally the $x,y$ dependence of quantities is suppressed but dependence on $s$ (formerly $z$) is given for emphasis.

\renewcommand{\arraystretch}{2}
$$\begin{array}{lcccr}
\textbf{Stage} & \textbf{Time} & \textbf{Dim} & \textbf{Computation/Equation} & \textbf{Notes} \\
1 & l & 2 & \grad h,\quad \alpha=|\grad h|, \quad H=h-b & \eqref{stagnote} \\
2 & l & 3 & P(s)=\rho g (H-s), \quad \sigma'(s)=P\alpha, \quad \delta(s)=2 F(T,\sigma',P) P & \eqref{Fnote} \\
3 & l & 3 & I(s)=\int_0^s \delta(s')\,ds', \quad J(s)=sI(s)-\int_0^s s'\delta(s')\,ds' & \eqref{vertintnote}\\
4 & l & 2 & \bU_b \text{ computed from } H, \grad h, \text{ and } T& \eqref{basalnote} \\
5 & l & 2 & D=J(H) & \eqref{interpnote} \\
6 & l+1 & 2 & h_{l+1} \text{ computed from} & \eqref{hfirstnote} \\
 &  &  & \ddt{h}= a + \ddt{b} + \diverg \left(D \grad h - (h-b)\bU_b\right) & \\
\end{array}$$

\noindent If $l$ is a temperature update step proceed to:
$$\begin{array}{lcccr}
7\phantom{tage} & \phantom{bob}l\phantom{bob} & \phantom{bo}3\phantom{bo} & \bU(s)=- I(s) \grad h+ \bU_b & \\
8 & l & 2 & S \text{ computed (perhaps only diagnostically)} & \eqref{Snote} \\
9 & l & 3 & w(s)=\diverg \left(J(s)\grad h-s\bU_b\right)-\left(I(s)\grad h-\bU_b\right)\cdot\grad b + \ddt{b}-S & \eqref{wbasenote} \\
10 & l & 3 & \Sigma = \frac{2}{\rho c_p} F(T,\sigma',P) \sigma'^2; \quad \text{smooth if necessary} & \eqref{smoothnote}\\
11 & l+1 & 3 & T_{l+1} \text{ computed from } & \eqref{Tnote} \\
 &  &  & \ddt{T}+\bU\cdot\grad T + \left(w-\ddt{b}-\bU\cdot\grad b\right)\dds{T} = \frac{k}{\rho c_p} \dddsds{T} + \Sigma & \\
\end{array}$$

\medskip
\noindent\textbf{Notes:}
%\renewcommand{\labelenumi}{\textbf{\alph{enumi}}. }
\begin{enumerate}
\item\label{stagnote}  These are computed on a staggered grid in the Mahaffy \citep{Mahaffy} scheme, but could be computed on the regular grid \citep{HindmarshPayne}.
\item\label{Fnote} A subroutine computes the constitutive function $F$ in either Glen or Goldsby-Kohlstedt form.  See subsection \ref{Fsubsect}.
\item\label{vertintnote} Vertical integrals computed by trapezoid rule.  Could be computed on an unequally--spaced grid \citep{PayneDongelmans}.
\item\label{basalnote} See subsection \ref{basalsubsect}.
\item\label{interpnote} Will involve approximation of $J$ at the height $H$ based on vertical neighboring values at grid levels $s_k$.  Note $D$ is computed on a staggered grid.
\item\label{hfirstnote} Computed explicitly and therefore $O(\Delta t)$.
\item\label{Snote} See subsection \ref{basalsubsect}.
\item\label{wbasenote} This is formula \eqref{wintbase} from subsection \ref{incompsubsect}.  Note that $S$ may be so small that it can be ignored here.
\item\label{smoothnote} Smoothing used to control thermocoupled ``spoking'' instability.  Smoothing actually computed by FFT convolution with Gaussian.
\item\label{Tnote} Done semi--implicitly (Crank--Nicolson) in each vertical column with free boundary technique (no Jenssen change of variable).  Potentially uses unequally--spaced vertical grid.  Advection is by upwinding.  Advection and source terms are computed asymmetrically in time: use data at $t=t_l$.  Thus only $O(\Delta t)$.
\end{enumerate}


\newpage
\section{Numerical approximation by finite differences}\label{numsect}

This section attempts to address the details of the finite difference techniques for approximating the partial differential equations of the previous sections.  Inevitably some issues will be glossed over.

Some notation is also inevitable.  Suppose $(x_i,y_j,s_k,t_l)$ is a uniformly--spaced grid on a rectangular region $R$ with spacing $\Delta x,\Delta y, \Delta s,\Delta t$.\footnote{For now we suppose $\Delta s$ is constant.  (10/2002)}  Let
    $$T_{i,j,k,l} \approx T(x_i,y_j,s_k,t_l) \quad \text{ and }\quad h_{i,j,l}\approx h(x_i,y_j,t_l),$$
and so on.  We will confuse the \emph{values on the grid of the actual solution} with the \emph{values we compute on the grid}  (which is the usual convention, of course).

In finite difference formulas below, simplified notation ``$h$'', ``$h_{i+1}$'', ``$h_{j-1,l+1}$'', etc.~will be used.  This notation will be clear in the context: these three expressions correspond to $h_{i,j,l},h_{i+1,j,l},h_{i,j-1,l+1}$, respectively.  For computations which occur at a certain time (see the previous section), the time index $l$, $l+1/2$ or $l+1$ may be suppressed.

\subsection*{Staggered and regular grids and the gradient calculation}  We start from the basics, and the most basic calculation is the computation of $\grad h$ and $\alpha$ from the values of $h$ on the grid.  There are at least three well--known methods which are laid out in \citep{HindmarshPayne}.  For now we chose the one derived from Mahaffy \citep{Mahaffy}, which gives, for example
    $$(\grad h)_{i+1/2,j} \approx \ip{\frac{h_{i+1,j}-h_{i,j}}{\Delta x}}{\frac{h_{i+1,j+1}+h_{i,j+1}-h_{i+1,j-1}-h_{i,j-1}}{4\Delta y}}.$$
That is, the gradient is calculated on the points of the \emph{staggered grid}, which include $(x_{i+1/2},y_j)$, $(x_{i-1/2},y_j)$, $(x_i,y_{j+1/2})$, etc.  (Notation for a vector in two dimensions, $\ip{a}{b}=a\ihat+b\jhat$, is used here.)

See figures \ref{regsten} and \ref{stagsten} for the regular and staggered grids, and the variables computed on each grid.  (Points on the \emph{three} dimensional grid, in this paper, may be staggered in the horizontal but there will be no need for staggering in the vertical.)

\begin{figure}[ht]
\regfigure{reggridsten}{2}
\caption{Variables $b, \grad b, \ddt{b}, h, M, S, T, \bU_b, w$ are on the \emph{regular grid}.}
\label{regsten}
\end{figure}

\begin{figure}[ht]
\regfigure{staggridsten}{2}
\vspace{-4mm}
\caption{Variables $\alpha, b, \delta, D, h, \grad h, I, J, P, \sigma, T, \bU, \bU_b$ are on the \emph{staggered grid}.}
\label{stagsten}
\end{figure}

It will be useful to recognize that certain nonderivative quantities, in particular $h$, $T$, $b$, and $\bU_b$ are needed on \emph{both} the regular and staggered grid.  This will be seen in the details of in the next subsections.  In particular, the averages/linear interpolants
\begin{align}
h_{i+1/2}&=\frac{h_{i+1}+h}{2}, \quad h_{j+1/2}=\frac{h_{j+1}+h}{2}, \\
T_{i+1/2,k}&=\frac{T_{i+1,k}+T_k}{2}, \quad T_{j+1/2,k}=\frac{T_{j+1,k}+T_k}{2}\end{align}
are needed at various points in the computation.  The routine \mtt{basal} might return $\bU_b$ on both regular or staggered grid, or averaging could be done as above for $h,T$.  Similarly the subroutine \mtt{beddef} could return $b$ on both grids, or an average could be computed.  There are \emph{effectively} three values of $h$, $T$, $b$, $\bU_b$ per regular grid point.  See figure \ref{molecule}.

\begin{figure}[ht]
\regfigure{molecule}{1.75}
\vspace{-5mm}
\caption{Variables $h$, $T$, $b$, $\bU_b$ are needed at all three locations.}
\label{molecule}
\end{figure}

The Mahaffy style gradient calculation is then:
\begin{align}
(\grad h)_{i+1/2} &= \ip{\frac{h_{i+1}-h}{\Delta x}}{\frac{h_{i+1/2,j+1}-h_{i+1/2,j-1}}{2\Delta y}}, \\
(\grad h)_{j+1/2} &= \ip{\frac{h_{i+1,j+1/2}-h_{i-1,j+1/2}}{2\Delta x}}{\frac{h_{j+1}-h}{\Delta y}}.
\end{align}
We suppose that these vectors are computed in this manner at every one of the staggered grid points shown in figure \ref{stagsten}.  We also compute
\begin{equation}
  \alpha_{i+1/2} = |(\grad h)_{i+1/2}|, \quad \alpha_{j+1/2} = |(\grad h)_{j+1/2}|
\end{equation}
at every staggered grid point, where $|\ip{a}{b}|=\sqrt{a^2+b^2}$.


\subsection*{Computing pressure, stresses, and velocities at depth}\label{atdepthsubsect}  We want to calculate depth--dependent quantities at points on the three dimensional grid which are \emph{in} the ice.  This comment relates to the essential fact that we suppose a fixed spatial grid in $x,y,s$ even though the upper ice surface will move.  It follows that some grid points are in the ice and some are above the ice, and that the situation is time--dependent.

Though $h,H,b$ are related by $H=h-b$ and thus are not \emph{all} fundamental, it is nonetheless useful in what follows to go ahead and compute $H$ at the staggered grid points:
\begin{equation}
    H_{i+1/2}=h_{i+1/2}-b_{i+1/2}; \qquad H_{j+1/2}=h_{j+1/2}-b_{j+1/2}.
\end{equation}

Let $0\le s \le H_{max}$ be a predetermined range of possible ice thickness.  For $k=0,1,\dots,k_{max}$ suppose $s_0=0,s_1 ,\dots,s_k,\dots,s_{k_{max}}=H_{max}$ are the vertical levels.

Given a staggered grid point $(i+1/2,j)$ or $(i,j+1/2)$, define $k_{Hi}$ as the \emph{largest} $k$ so for which $s_k\le H_{i+1/2}$.  Similarly, $k_{Hj}$ is the largest $k$ so for which $s_k\le H_{j+1/2}$.  In other words, at staggered grid point $(i+1/2,j)$ the range of $k$ values for which $s_k$ is below the ice surface is $k=0,1,\dots,k_{Hi}$ (and the range at $(i,j+1/2)$ is $k=0,1,\dots,k_{Hj}$).

We compute many depth--dependent quantities at every horizontally staggered grid point but only from the base $s=0$ to the upper surface $s=H$, and thus only at grid levels $s_0$ through $s_{k_{Hi}}$ (or $s_{k_{Hj}}$) for a given horizontal location.

In particular we compute the pressure $P$ and the effective shear stress $\sigma$ at every staggered grid point and at the appropriate range of levels:
\begin{align}
  P_{i+1/2,k}&=\rho g \left(H_{i+1/2}-s_k\right), \quad \sigma_{i+1/2,k}=P_{i+1/2,k} \alpha_{i+1/2}, \qquad (0\le k \le k_{Hi}) \\
  P_{j+1/2,k}&=\rho g \left(H_{j+1/2}-s_k\right), \quad \sigma_{j+1/2,k}=P_{j+1/2,k} \alpha_{j+1/2}, \qquad (0\le k \le k_{Hj}).\notag
\end{align}
Similar restrictions on $k$ apply to $\delta,\bU$, etc.~which follow.

From the values of $T$ we compute the local diffusivity $\delta$:
\begin{align}
\delta_{i+1/2,k}&=2 \,F(T_{i+1/2,k},\sigma_{i+1/2,k},P_{i+1/2,k})\,P_{i+1/2,k}, \\
\delta_{j+1/2,k}&=2 \,F(T_{j+1/2,k},\sigma_{j+1/2,k},P_{j+1/2,k})\,P_{j+1/2,k}\notag
\end{align}
where $F(T,\sigma,P)$ is one of the constitutive functions described earlier.

Again, temporarily, we suppose that the vertical grid spacing is uniform with spacing $\Delta s$.  We compute the integral $I(s)=\int_0^s \delta(s')\,ds'$ in the main table approximately by the \emph{trapezoid} rule:
\begin{align}
I_{i+1/2,j,0}&=0; \qquad I_{i+1/2,j,k+1}= I_{i+1/2,j,k} + \frac{\Delta s}{2}\left(\delta_{i+1/2,j,k}+\delta_{i+1/2,j,k+1}\right), \notag\\
I_{i,j+1/2,0}&=0; \qquad I_{i,j+1/2,k+1}= I_{i,j+1/2,k} + \frac{\Delta s}{2}\left(\delta_{i,j+1/2,k}+\delta_{i,j+1/2,k+1}\right).\notag
\end{align}
Other integration methods than the trapezoid rule are clearly possible. [BUT I FORESEE THAT THEY ARE NOT NEEDED]   The error associated with this integral approximation is at most $\frac{1}{12} \left(\max |\delta''(s)|\right) (\Delta s)^2$.

The integral $J(s)$ is also computed by the trapezoid rule, but it is easiest to first approximate
    $$K(s)=\int_0^s s' \delta(s')\,ds',$$
as follows:
\begin{align}
K_{i+1/2,j,0}&=0; \qquad K_{i+1/2,j,k+1}= K_{i+1/2,j,k} + \frac{\Delta s}{2}\left(s_k \delta_{i+1/2,j,k}+s_{k+1}\delta_{i+1/2,j,k+1}\right), \notag\\
K_{i,j+1/2,0}&=0; \qquad K_{i,j+1/2,k+1}= K_{i,j+1/2,k} + \frac{\Delta s}{2}\left(s_k \delta_{i,j+1/2,k} + s_{k+1}\delta_{i,j+1/2,k+1}\right).\notag
\end{align}
Then $J(s)=sI(s)-K(s)$, that is,
\begin{equation}
  J_{i+1/2,j,k}=s_k I_{i+1/2,j,k} - K_{i+1/2,j,k}, \qquad J_{i,j+1/2,k}=s_k I_{i,j+1/2,k} - K_{i,j+1/2,k}.
\end{equation}
The error associated with the integral approximation of $K$ is at most $\frac{1}{12} \left(\max |2\delta'(s)+\delta''(s)|\right) (\Delta s)^2$ (consider the second derivative of the integrand).

Given the above data $H,b,\alpha,\grad h,T$ all known at a given staggered, basal grid point $(x_{i+1/2},y_j,s_0=0)$ or $(x_i,y_{j+1/2},s_0=0)$ we determine, from the function \mtt{basal} (described in subsection 1.6), the basal sliding velocity $\bU_b$ and the basal melt rate $S$:
\begin{equation}
  \mtt{basal} \to (\bU_b)_{i,j}; \quad (\bU_b)_{i+1/2,j};\quad (\bU_b)_{i,j+1/2}; \quad S_{i+1/2,j}; \quad S_{i,j+1/2}.
\end{equation}
Recall (in what follows) that $\bU_b=\ip{u_b}{v_b}$.  Note that $\bU_b$ is needed on both the regular and staggered grids.

It is now easy to determine the horizontal velocity at depth:
\begin{align}
\bU_{i+1/2,j,k} &= - I_{i+1/2,j,k} (\grad h)_{i+1/2,j} + (\bU_b)_{i+1/2,j}, \\
\bU_{i,j+1/2,k} &= - I_{i,j+1/2,k} (\grad h)_{i,j+1/2} + (\bU_b)_{i,j+1/2}. \notag
\end{align}
Note that because $\grad h$ is most easily computed on the staggered grid it follows that $\bU$ is most easily computed there as well.

To compute the vertical velocity we use the integrated form of incompressibility, namely equation \eqref{wintbase} rewritten in the $s$ variable.  First, though, we need the gradient of $b$ on the regular grid:
\begin{equation}(\grad b)_{i,j} = \ip{(b_x)_{i,j}}{(b_y)_{i,j}} = \ip{\frac{b_{i+1}-b_{i-1}}{2\Delta x}}{\frac{b_{j+1}-b_{j-1}}{2\Delta y}}.\end{equation}
Then
\begin{align}
w_{i,j,k} &= \frac{1}{\Delta x}\left[J_{i+1/2}(h_x)_{i+1/2}-J_{i-1/2} (h_x)_{i-1/2}\right] + \frac{1}{\Delta y}\left[J_{j+1/2}(h_y)_{j+1/2}-J_{j-1/2} (h_y)_{j-1/2}\right] \notag\\
    &\quad - \frac{s_k}{\Delta x}\left[(u_b)_{i+1/2}- (u_b)_{i-1/2}\right] - \frac{s_k}{\Delta y}\left[(v_b)_{j+1/2}- (v_b)_{j-1/2}\right] \notag\\
    &\quad -\frac{1}{2}\left[I_{i+1/2}(h_x)_{i+1/2}-(u_b)_{i+1/2} + I_{i-1/2}(h_x)_{i-1/2}-(u_b)_{i-1/2}\right](b_x)_{i,j} \notag\\
    &\quad -\frac{1}{2}\left[I_{j+1/2}(h_y)_{j+1/2}-(v_b)_{j+1/2} + I_{j-1/2}(h_y)_{j-1/2}-(v_b)_{j-1/2}\right](b_y)_{i,j} \notag\\
\label{wfdeqn}    &\quad + \left(\ddt{b}\right)_{i,j} - S_{i,j}.\end{align}

Before moving on to use these computed velocities in the evolution of the upper surface and the temperature field, we must deal directly with the free boundary nature of the problem.  Indeed the range of $k$ for which $(x_i,y_j,s_k)$ is a point within the ice depends on $x$, $y$, $t$ (i.e.~on indices $i$, $j$, $l$).  In computing $P$, $\sigma$, $\delta$, $I$, $J$, $\bU$ this presents no difficulty.  For the vertical velocity, however, we compute a horizontal derivative for the first time.  Thus there must be a rule for dealing with the situation shown in the figure below.  In the case shown, $w_{i,j,k}$ is desired but one of the staggered horizontal grid neighbors is outside of the ice and thus has no defined $P$, $\sigma$, $J$, etc.  In particular, one of the terms on the right side of \eqref{wfdeqn} will be missing.

\begin{figure}[ht]
\vspace{-4mm}
\regfigure{bdrywsitfig}{2.5}
\vspace{-6mm}
\caption{How to determine $w_{i,j,k}$ if the horizontal neighbors are not in the ice?}
\label{bdrywsit}
\end{figure}

The authors know of no \emph{best} rule to deal with this situation [COMMENT?!] but a number of simple and reasonable rules exist.  The simplest of these is to copy the value of $w$ from the grid point below: $w_{i,j,k}=w_{i,j,k-1}$.  Other simple rules include averaging the defined neighboring values or extrapolating from values below.  More sophisticated rules would come from using the incompressibility relation $\diverg \bU+\ddz{w}=0$ in an enlightened manner.

With this caveat on the computation of $w$ we claim that all of $P, \sigma, \delta, I, J, \bU,$ and $w$ can be computed quickly by starting with the bottom layer of the ice (at $s=0$) and moving up layer by layer.  In particular, this concludes our discussion of stages 2, 3, 4, 5, 6 in the main table.

[FILL IN SOME COVERAGE OF MACAYEAL VELOCITIES]

\subsection*{Computation of diffusivity}  As described in sections 1 and 2, the diffusivity $D$ in the ice flow equation is the value of the integral $J$ at the upper surface, that is, $D=J(s=H)$.  Computing $D$ therefore involves a modest approximation because $s=H$ usually falls between the vertical grid values $s_k$.  By definition, in fact, at the horizontal staggered grid point with indices $(i+1/2,j)$ the level $s=H$ is between $s_{k_{Hi}}$ and $s_{k_{Hi}+1}$.  A similar comment applies to $(i,j+1/2)$.

We will use the value of $J(s)$ and its derivatives $\dds{J}$, $\dddsds{J}$, all at $s=s_{k_{Hi}}$, to estimate $D=J(H)$.  Note that
    $$\dds{J} = I(s) = \int_0^s \delta(s')\,ds' \quad \text{because } \quad J(s) = \int_0^s (s-s') \delta(s')\,ds'$$
and
    $$\dddsds{J}=\delta(s) \quad \text{because } \quad I(s) = \int_0^s \delta(s')\,ds'.$$

Thus the following are second order estimates of $J(H_{i+1/2,j})$ and $J(H_{i,j+1/2})$, respectively:
\begin{align}
D_{i+1/2,j}&=J_{i+1/2,k_{Hi}} + (H_{i+1/2}-s_{k_{Hi}}) \left(I_{i+1/2,k_{Hi}} + \frac{1}{2} \delta_{i+1/2,k_{Hi}} (H_{i+1/2}-s_{k_{Hi}})\right), \\
D_{i,j+1/2}&=J_{j+1/2,k_{Hj}} + (H_{j+1/2}-s_{k_{Hj}}) \left(I_{j+1/2,k_{Hj}} + \frac{1}{2} \delta_{j+1/2,k_{Hj}} (H_{j+1/2}-s_{k_{Hj}})\right).
\end{align}

These values for $D$ are based on quadratic approximation of the function $J(s)$ and thus have a maximum error $\frac{1}{6} \left(\max |\delta'(s)|\right) (\Delta s)^3$ (consider the third derivative of the function $J(s)$).  Thus this local error is smaller than the error made in approximating $J$ itself by the trapezoid rule.

We have now completed stages ??? and ??? in the main table and will move on to the computation of one time step for the main nonlinear partial differential equation, that is, the ice flow equation for the shape of the upper surface.

\subsection*{One time step for the ice flow equation}  Recall the ice flow equation as it appears in the main table:
\begin{equation}\label{iceagain}
\ddt{H}= M - S + \left[\diverg \left(D^e \grad h - H\bU_b\right)\right]\chi_{\{h>b\}}.\end{equation}
At this point in the computation of one time step of the whole numerical model (i.e.~one pas through the main table), the functions $M,S,D^e$ and $\bU_b$ are known.

[FILL IN CURRENT DETAILS FOR EXPLICIT SCHEME, ADAPTIVE TIME STEPPING]

%\bigskip
\subsection*{One time step for the temperature equation}  The temperature equation \eqref{Teqn}, or rather its $z\to s$ transformed version in the main table, is a time--dependent and three--spatial dimension partial differential equation.  It is linear nonhomogeneous in $T$ \emph{if} one supposes the geometry, the velocity fields, and the strain--heating source to be fixed.  In fact there is nonlinear coupling of $T$ to flow, and thus back to $T$, through these fields, and through the thickness evolution itself which determines the upper boundary of the region on which the temperature equation is solved.

For the duration of one time step, or at least in computing stage 10 of the main table, we nevertheless suppose the thickness $H$, the velocity $\bu$, and the source $\dot\eps_{ij}\sigma_{ij}$ to be fixed functions of space.  [FIXME: lots to be done here!]  Let
    $$\Sigma = \frac{\dot\eps_{ij}\sigma_{ij}}{\rho c_p}, \quad \tilde w=w-\ddt{b}-\bU\cdot \grad b, \quad \text{ and } K=\frac{k}{\rho c_p}$$
(the last is a constant, of course).  Our temperature equation becomes
\begin{equation}\label{simpTemp}
\ddt{T}+u\ddx{T}+v\ddy{T}+\tilde w \dds{T} = K \dddsds{T}+\Sigma.
\end{equation}
where, while computing this stage, $u=u(x,y,s,t_l)$, $v=v(x,y,s,t_l)$, $\Sigma=\Sigma(x,y,s,t_l)$ are known functions of space.

The left side of \eqref{simpTemp} is a ``material derivative'', of course, but from the numerical aspect (in this finite difference approximation) one treats $\ddt{}$ rather differently from the spatial derivatives.  In fact, we will ``upwind'' the spatial derivatives (\citep{Pressetal,PayneDongelmans}).  As noted in \citep{BBL}, the temperature equation can be advection-dominated \citep{MortonMayers}, with both the horizontal and vertical advection velocities being quite significant.  Let
\begin{equation}\label{Updef}
\Up(f\big|i,\vf) = \begin{cases} \vf\frac{f_i-f_{i-1}}{\Delta x}, & \vf\ge 0, \\ \vf\frac{f_{i+1}-f_i}{\Delta x}, & \vf< 0\end{cases}
\end{equation}
approximate the quantity $\vf \ddx{f}$ at position $i$.  That is, determine a one--sided difference approximation to $\ddx{f}$ using the sign of $\vf$ and then multiply by $\bf$ as a coefficient.  (As in \citep{PayneDongelmans}, one could substitute second--order upwinding for \eqref{Updef}.\footnote{No evidence exists that second order upwinding is more accurate \emph{globally}, in the ice models in the literature.  Such evidence would essentially require comparison to an exact time--dependent solution \citep{BBL}.})  As an example of the use of the ``$\Up$'' notation, suppose $T_{i,j,k,l}=T(x_i,y_j,s_k,t_l)$ is known on the grid.  Then the term $v\ddy{T}$ in \eqref{simpTemp} is approximated by $\Up(T_{i,\cdot,k,l} \big| j, v_{i,j,k,l})$.

Thus we propose
\begin{align}\label{fdTemp}
&\frac{T_{i,j,k,l+1}-T_{ijkl}}{\Delta t} + \Up(T_{\cdot,j,k,l} \big|i,u_{ijkl}) + \Up(T_{i,\cdot,k,l} \big|j,v_{ijkl}) + \Up(T_{i,j,\cdot,l} \big|k,\tilde w_{ijkl}) \\
    &\qquad =K\frac{T_{i,j,k+1,l+1} - 2 T_{i,j,k,l+1} + T_{i,j,k-1,l+1}}{\Delta s^2} + \Sigma_{ijkl}.\notag
\end{align}
as our (LIKELY TO BE) stable, semi--implicit scheme.  It is ``semi--implicit'' because there is dependence on $T$ in the velocities $u,v,\tilde w$ and in the source $\Sigma$.

Method \eqref{fdTemp} has (more or less, obviously) $O(\Delta t,\Delta x,\Delta y, \Delta s)$ local truncation error.  Second--order upwinding would give $O(\Delta t,\Delta x^2, \Delta y^2, \Delta s^2)$ but there is no practical way to get $O(\Delta t^2,\dots)$.  That is, one could try to set up a Crank--Nicolson type scheme for \eqref{simpTemp} to get the better accuracy in time.  Success would require a fully nonlinear solution, for all values of $T$ on the three--dimensional grid, of the equation through its coupling to the rest of the model.  Such an equation would at least require a series of linear 3D solutions and probably require differentiating the whole model to do Newton--Raphson.  Thus full Crank--Nicolson has prohibitive complexity (for a thermocoupled model, for now).

Because of the advection, the adaptive time-stepping scheme for the temperature equation requires, as a roughly necessary condition for stability, that the CFL condition be applied \citep[see][]{BBL}; \citep[compare][]{MortonMayers}.

In any case, \eqref{fdTemp} requires the solution of a system of linear equations in \emph{each vertical column}.  In particular, \eqref{fdTemp} can be rearranged to
\begin{align}\label{triTemp}
-R &T_{k+1,l+1} + (1+2R) T_{k,l+1} - R T_{k-1,l+1} \\
    &\quad = -\Delta t \left(\Up(T_{\cdot,j,k,l} \big|i,u_{ijkl}) + \Up(T_{i,\cdot,k,l} \big|j,v_{ijkl}) + \Up(T_{i,j,\cdot,l} \big|k,\tilde w_{ijkl}) - \Sigma_{ijkl}\right) + T_{k,l}\notag
\end{align}
where $R=\frac{K\Delta t}{\Delta s^2}$.  This is a tridiagonal, symmetric, diagonally--dominant system which has an efficient (and accurate) solution by well--known means \citep{Pressetal}.

Note that for $k \ge k_H = \max\{k\big|s_k\le H_{ijl}\}$, the grid point $(x_i,y_j,s_k)$ is outside of the ice at time $t_l$--compare section \ref{atdepthsubsect}.  We can therefore set
\begin{equation}\label{Taboveice}
T_{ijkl}=T_s(x_i,y_j,H_{ijl},t_l) \qquad \text{if} \qquad k\ge k_H.
\end{equation}
The size of the tridiagonal matrix problem \eqref{triTemp} for the vertical column at $(x_i,y_j)$, at time $t_l$, is thereby determined by $H_{i,j,l}$.

We also have a lower boundary condition \eqref{tempbasecond}.  Transforming to $s$ coordinates this becomes
\begin{equation}\label{stempbasecond}
k\dds{T}\Big|_{s=0} = -G.
\end{equation}

See the section on temperature in a column for a more complete view of the basal conservation of energy computation, and the inclusion of temperature modelling within the bedrock.  [FIXME: this part needs updating!]

We see that the nontrivial tridiagonal system in each column is formed from \eqref{triTemp} for $k=1,...,k_H-1$, and from \eqref{stempbasefd}, and also from \eqref{Taboveice} for $k=k_H$.  For $k_H=5$, for example, the system has the following structure:
\newcommand{\bul}{\bullet}
    $$\begin{pmatrix} \quad \bul \quad & \quad \bul \quad & \quad 0 \quad & \quad 0 \quad & \quad 0 \quad & \quad 0 \quad \\ \bul &\bul & \bul & 0 & 0 & 0 \\ 0 & \bul & \bul & \bul & 0 & 0 \\ 0 & 0 & \bul & \bul & \bul & 0 \\ 0 & 0 & 0 & \bul & \bul & \bul \\ 0 & 0 & 0 & 0 & 0 & 1 \end{pmatrix} \begin{pmatrix} T_{k=0} \\ T_{k=1} \\ T_{k=2} \\ T_{k=3} \\ T_{k=4} \\ T_{k=5} \end{pmatrix}  =  \begin{pmatrix} [\text{see \eqref{stempbasefd}}] \\  \\ [\text{see} \\ \eqref{triTemp}] \\  \\ T_s \end{pmatrix}.$$
(Note that \eqref{triTemp} generates all but the first and last rows of the matrix.)

We now suppose that stage 10 of the main table can be completed efficiently.  In fact, we suppose that (FOR FIRST DRAFT PURPOSES) the computations in the main table, and thus much of the model, can be turned into a program.

[A CONVERGENCE PROOF IS POSSIBLE FOR THE SCHEME DESCRIBED HERE \citep{BBL}]

[FILL IN CURRENT DETAILS FOR CFL and AGE]






\newpage
\section{On the temperature problem in a column of flowing, sliding ice over bedrock}

\subsection*{Conservation of energy for a segment of a column}  Consider a column of a slowly flowing and heat conducting material as shown in the left side of figure \ref{fig:earlycols}.  This is an ``Eulerian'' view; the material flows through the column, which remains fixed (and is notional).  The column is vertical.  We will assume when needed that it is rectangular in cross-section with cross-sectional area $\Delta x\Delta y$.

\begin{figure}[ht]
\vspace{0.2in}
\hspace{1.0in}\regfigure{earlycols}{2.6}
\vspace{0.2in}
\caption{\emph{Left}: A general column of flowing and heat conduction material showing a small segment $V$.  \emph{Right}: A more specific column of ice flowing and sliding over bedrock.}
\label{fig:earlycols}
\end{figure}

Ideas: \begin{enumerate}
\item Conservation of energy within a segment of the column  tells us the temperature equation.
\item Standard approximations to the relevant quantities (i.e.~some kind of quadrature), within a segment and at its boundaries, will give a numerical method.\end{enumerate}
We now flesh-out these two ideas, that is, this section contains a ``finite-volume''-style derivation the temperature equation and of our numerical method for it.

The rate of change of the thermal energy within a completely generic segment shown on the left side of figure \ref{fig:earlycols} satisfies
\begin{equation}\label{mostgeneral}
\DDt{}\left(\int_V \rho c_p T\right) = \mathcal{I} - \int_{\partial V} \bq \cdot \nhat
\end{equation}
where $\mathcal{I}$ stands for the sum of all internal heat sources, $\partial V$ is the surface of the segment (all sides together as one closed surface), $\bq$ is the flux of thermal energy (a vector field we assume is well-defined everywhere), and $\nhat$ is the \emph{outward} normal vector.  Here $\rho$ is the density of the material and $c_p$ its specific heat; at this point we assume these vary throughout the material, generally in a discontinuous manner.  Note there is an implied volume element in the integral on the left and an implied area element in the integral on the right.  The units (of both sides of) equation \eqref{mostgeneral} are Joules per second, that is, Watts.

The most important assumption which is made in using \eqref{mostgeneral} is that all internal energy in the segment is sensible, that is, it is computed by the formula on the left.  In the case of latent heat from partial melting equation \eqref{mostgeneral} must change; below.  In any case, equation \eqref{mostgeneral} only applies if $T < \Tpmp$ for all points in $V$.  Recall that the pressure-melting temperature is $\Tpmp = T_0 - \beta (\text{depth})$ where $T_0=273.15\,\text{K}$ and $\beta = 8.7 \times 10^{-4}\,\text{K}\,\text{m}^{-1}$.

By Fourier's law \citep{Fowler}, the flux of heat \emph{by conduction} at any point in the material is
    $$\bq_{\text{conduct}} = - k \grad T$$
where $k$ is the thermal conductivity of the material; $k$ may vary spatially in general.  In addition, however, the flow of material transports heat:
    $$\bq_{\text{transport}} = \rho c_p T \bU,$$
where $\bU$ is the three-dimensional velocity field of the material.  The total heat flux is $\bq = \bq_{\text{conduct}} + \bq_{\text{transport}}$.  Units of $\bq$ are Watts per square meter; consistency of units can be checked for these flux formulas.

The only significant source of heat within a segment is the strain-heating (viscous heating) of the material.  That is, we assume that the material does not accelerate significantly and thus that the work of the driving forces on the material is completely converted to heat.  Note we ignore firn compactification, though we will address partial melting below.  It follows that \citep[see][]{Paterson}
\begin{equation}\label{basicG}
\mathcal{I} = \int_V \dot\eps_{ij} \sigma_{ij}.
\end{equation}
using the summation convention, of course.  The product of tensors in the integrand is the inner product $\ip{A}{B}=\tr(A^\top B)$ of two real matrices.  Note $\dot\eps_{ij} \sigma_{ij}$ has units of Watts per cubic meter.  It will turn out that when the segment in question includes a sliding plane, as when the ice is sliding over the rock, there will be a different distribution of the same basic kind of heat source, namely the basal frictional heating; equation \eqref{basicG} will be modified for that case below.

For a general \emph{incompressible} material with \emph{spatially constant material properties within the segment} we can transform the surface integral of $\bq_{\text{transport}}$ by using the divergence theorem:
\begin{align*}
\int_{\partial V} \rho c_p T \bU \cdot \nhat &= \int_V \Div\left[\rho c_p T \bU\right] = \int_V \left[T \grad(\rho c_p) \cdot \bU + \rho c_p \grad T \cdot U + \rho c_p T \Div \bU\right] \\
    &= \int_V \rho c_p \bU \cdot \grad T.
\end{align*}
The last equality follows from the constancy of $\rho c_p$ and from incompressibility $\Div \bU = 0$.  This calculation does not apply for a segment across the ice-rock interface.

Let's assume that the material properties are independent of time; in fact this assumption is justified in our context.  Then the more general equation of conservation \eqref{mostgeneral} of thermal energy becomes
\begin{equation}\label{general}
\int_V \rho c_p \ddt{T} = \int_V \dot \eps_{ij} \sigma_{ij} + \int_{\partial V} k \grad T \cdot \nhat - \int_V \rho c_p \bU \cdot \grad T.
\end{equation}

An alternate derivation might define the material derivative
    $$\frac{D T}{dt} := \ddt{T} + \bU\cdot \grad T$$
rewrite equation \eqref{general} as
    $$\int_V \rho c_p \frac{D T}{dt} = \int_V \dot \eps_{ij} \sigma_{ij} + \int_{\partial V} k \grad T \cdot \nhat,$$
but we find the derivation actually used to be illuminating when material properties are not constant, as in the case of a segment across the ice-bedrock interface or in the case of the transport of partly-melted ice, both of which are dealt with below.


\subsection*{Specialization to shallow ice flow over bedrock}  The above is the general set-up.  As shown in the right side of figure \ref{fig:earlycols}, we are interested in a special case.  In particular, the ice is shallow.  We assume that the material properties of ice (density, specific heat, conductivity) are constant: $\rho=\rho_I,c_p=c_I,k=k_I$.  (This means we do not consider the transformation of firn to ice within the topmost part of the ice column.)  Similarly in the bedrock we assume constant material properties: $\rho=\rho_R,c_p=c_R,k =k_R$.  The correct derivation of the shallow temperature equation follows a small-parameter argument, and in the case of inland flow such an argument is given in \citep{Fowler}.  Such small-parameter arguments do not, however, directly yield numerical methods, which is part of our purpose here.

The segments of interest generically have dimensions $\Delta x \times \Delta y \times \Delta z$, but with
    $$\Delta z \ll \min\{\Delta x, \Delta y\}.$$
Indeed $\Delta z / \Delta x \approx 10^{-3}$ is completely typical.  That is, the segments are flat and thin.  Because the conduction of heat in ice is (assumed to be, but very reasonably) isotropic, the thinness of a segment means that the heat loss through the sides of the segment \emph{by conduction} is very small compared to the loss through the top and bottom; we drop that term for the sides.  Heat flux by advection is different, however, because the velocity is nearly horizontal in shallow ice flows, as vertical speeds are a typical factor $10$ to $10^3$ smaller than horizontal speeds.  The heat flux through transport can be significant through all sides of our segment.

In the circumstances of shallow ice sheet flow \citep{Fowler} the strain-heating rate in the ice simplifies as follows:
\begin{equation}\label{strainheatingSIA}
\dot\eps_{ij}\sigma_{ij} \approx 2\dot\eps_{xz}\sigma'_{xz} + 2\dot\eps_{yz}\sigma'_{yz} = 2 F(T,\sigma',P) \left({\sigma'_{xz}}^2 + {\sigma'_{yz}}^2\right) = 2 F(T,\sigma',P) P^2 |\grad h|^2.
\end{equation}
This approximation incorporates the general isotropic flow law \eqref{constitutive}.

Within an ice shelf or ice stream, however, the shear strain rates in planes parallel to the geoid are dropped and the strain-heating term has a different approximate form:
\begin{align*}
\dot\eps_{ij}\sigma_{ij} &\approx \dot\eps_{xx}\sigma_{xx} + \dot\eps_{yy}\sigma_{yy} + \dot\eps_{zz}\sigma_{zz} + 2 \dot\eps_{xy}\sigma_{xy} \\
    &= \dot\eps_{xx}(\sigma'_{xx} + P) + \dot\eps_{yy}(\sigma'_{yy} + P) + \dot\eps_{zz}(\sigma'_{zz} + P) + 2 \dot\eps_{xy}\sigma'_{xy} \\
    &= \dot\eps_{xx}\sigma'_{xx} + \dot\eps_{yy}\sigma'_{yy} + \dot\eps_{zz}\sigma'_{zz}  + 2 \dot\eps_{xy}\sigma'_{xy}.
\end{align*}
The last equality follows from $\dot\eps_{xx} + \dot\eps_{yy} + \dot\eps_{zz} = 0$, that is, incompressibility \eqref{incomp}.  Thus, using the viscosity form $\sigma'_{ij} = 2 \nu(T,\dot\eps,P) \dot\eps_{ij}$ of the flow law \eqref{constitutive},
\begin{align}
\dot\eps_{ij}\sigma_{ij} &\approx 2 \nu(T,\dot\eps,P) \left({\dot\eps_{xx}}^2 + {\dot\eps_{yy}}^2 + {\dot\eps_{zz}}^2  + 2{\dot\eps_{xy}}^2\right) = 4 \nu(T,\dot\eps,P) \left({\dot\eps_{xx}}^2 + {\dot\eps_{yy}}^2 + \dot\eps_{xx} \dot\eps_{yy} + {\dot\eps_{xy}}^2\right). \label{strainheatingSHELF}
\end{align}
In the last equality we have again used incompressibility \eqref{incomp} to eliminate $\dot\eps_{zz}$.  Note that to numerically compute \eqref{strainheatingSHELF} we recall $\dot\eps_{xx} = \partial u/\partial x$, $\dot\eps_{yy} = \partial v/\partial y$, and $\dot\eps_{xy} = (1/2)\left(\partial u/\partial y + \partial v/\partial x\right)$; these are approximate-able quantities in ice shelves and streams.

With these shallow approximations we can restate the basic conservation of energy equation \eqref{general} within a segment for an inland ice sheet columns as
\begin{equation}\label{conserveSIA}
\rho_I c_I \int_V \ddt{T} = \int_V 2 F(T,\sigma',P) P^2 |\grad h|^2 + k_I \int_{S^+ \cup S^-} \grad T \cdot \nhat - \rho_I c_I \int_V \bU \cdot \grad T;
\end{equation}
Here $S^+,S^-$ denote the upper and lower surfaces of a segment.  Note that the integral with ``$\grad(\rho c_p)$'' vanishes because material properties of an ice-only segment are constant.  Within shelves and streams there is a nearly identical formula, except that the first integral on the right in \eqref{conserveSIA} is replaced by
\begin{equation*}
(\text{strain heating in shelves/streams}) =  \int_V 4 \nu(T,\dot\eps,P) \left({\dot\eps_{xx}}^2 + {\dot\eps_{yy}}^2 + \dot\eps_{xx} \dot\eps_{yy} + {\dot\eps_{xy}}^2\right).
\end{equation*}
From now on we will simply write $\int_V \dot \eps_{ij} \sigma_{ij}$ for this term, understanding that \eqref{strainheatingSIA} or \eqref{strainheatingSHELF} indicate how to compute the term in context.

Within the rock the conservation law is simpler.  The segments in question are still shallow so only conduction through the upper and lower faces needs to be included.  We assume no flow of rock and therefore there is no heat flux through transport and also no strain heating.  It follows that we can restate the conservation of energy \eqref{general} as
\begin{equation}\label{conserveROCK}
\rho_R c_R \int_V \ddt{T} = k_R \int_{S^+ \cup S^-} \grad T \cdot \nhat.
\end{equation}

The case of a segment across the ice-rock bed interface has not been forgotten, and will be dealt with a bit later.  Additionally it is important to include the right physics for melting.  That is, the above analysis assumes cold ice whose temperature increases linearly with increasing internal energy.  At the melting point, however, there is storage of internal energy in the form of latent heat.  This situation, and the closely-related computation of a basal melting rate, will be addressed later.  Finally, the case of a column in an ice shelf, with lower end in contact with ocean water, must also be dealt with correctly.

\begin{figure}[ht]
\vspace{0.2in}
\regfigure{fourcases}{4.0}
\vspace{0.1in}
\caption{Four cases of a segment of the column: From the top there is a generic ice segment, a segment across the ice-rock interface, a generic rock segment, and a rock segment with a Neumann (heat-flux-specified) boundary condition.  At the top of the column is a Dirichlet (temperature-specified) boundary condition for which no finite-volume derivation is needed.}
\label{fig:segments}
\end{figure}


\subsection*{Approximation for generic segments}  We have been maintaining equations in integral form deliberately because our goal is a numerical method.  So suppose there is a rectangular grid in the horizontal.  We do not need to be terribly specific except to use $x_i,y_j$ to denote the horizontal center of each column under consideration, and to suppose the columns have rectangular cross-section with area $\Delta x\Delta y$.  For this column, the various segment cases we consider are shown in figure \ref{fig:segments}.  For each of these cases we will derive a spatially-discrete approximation of the above conservation equations \eqref{conserveSIA}, \eqref{conserveROCK}, etc.

Additionally suppose there is a grid in the vertical as in figure \ref{fig:verticalgrid}.  There are (generally) unequally-spaced ``regular'' grid points $\{z_k\}_{k=0}^{k_{\max}}$ and ``staggered'' grid points $\{\zeta_k\}_{k=1}^{k_{\max}}$ such that $z_{k-1} < \zeta_k < z_k$.  The staggered grid points are otherwise unspecified at this point, but in practice they might be the midpoints of the intervals $[z_{k-1},z_k]$.  Let
    $$\Delta z_k = \zeta_{k+1} - \zeta_k$$
denote the height of the segment.  By definition, then, a segment is a set ``centered'' at $(x_i,y_j, z_k)$ with volume $\Delta x \Delta y \Delta z_k$:
    $$V = \left\{(x,y,z) \quad\big|\quad \zeta_k < z < \zeta_{k+1} \text{ and } x, y \text{ in the column with center } (x_i,y_j) \right\}.$$

\begin{figure}[ht]
\vspace{0.2in}
\regfigure{verticalgrid}{4.0}
\vspace{0.2in}
\caption{Unequally-spaced vertical grid $\{z_k\}$ with staggered points $\{\zeta_k\}$ in between; $\Delta z_k= \zeta_{k+1} - \zeta_k$ is the distance between consecutive \emph{staggered} grid points.  Note that the ice-rock interface is at $z=z_k$ for some $k>0$ but is denoted $z=z_\ast$.}
\label{fig:verticalgrid}
\end{figure}

We will generally approximate integrals over a segment $V$ by evaluating the integrand at $(x_i,y_j, z_k)$.  We will generally approximate integrals over faces by their values at the ``center'' of the face, appropriately interpreted.  That is, we will generally do finite volume approximations of various quantities using the midpoint quadrature rule.  Furthermore, in this subsection we will do only the lowest-order consistent approximations, but higher-order methods are possible using the same grid notation.  We generally will not discretize in time in this section.

Denote the approximation to $T(x_i,y_j,z_k,t)$ by $T_k(t)$ or $T_k$, notation which, for brevity, suppresses the dependence on $i$ and $j$.  Similarly, let $P_k = \rho_I g (h(x_i,y_j,t)-z_k)$ and suppose $\alpha$ is an approximation to $|\grad h|$ at $(x,y)=(x_i,y_j)$ and at time $t$.   Then $\sigma'_k = P_k \alpha$ is an approximation to the effective shear stress at $(x_i,y_j,z_k)$.  Let $F_k = F(T_k,\sigma'_k,P_k)$.

For a generic inland ice segment we approximate \eqref{conserveSIA} by
\begin{align}
\rho_I c_I \ddt{T_k} \Delta x \Delta y \Delta z_k &= \left(\dot\eps_{ij} \sigma_{ij}\right)_k \Delta x \Delta y \Delta z_k + k_I \left(\frac{T_{k+1}-T_k}{z_{k+1}-z_k} - \frac{T_k-T_{k-1}}{z_k-z_{k-1}}\right) \Delta x \Delta y \label{conserveSIAfd} \\
    &\quad - \rho_I c_I \int_V \bU \cdot \grad T. \notag
\end{align}
Note that face $S^+$ is at $z=\zeta_{k+1}$ and the conduction flux integral over that face is approximated by
    $$\int_{S^+} \grad T\cdot \nhat = \int_{S^+} \grad T\cdot(+\khat) \approx \frac{T_{k+1}-T_k}{z_{k+1}-z_k} \Delta x \Delta y$$
based on a piece-wise linear form for $T(z)$.  A similar approximation is done on face $S^-$.

An integral remains in \eqref{conserveSIAfd}.  Note that with given values $T_{k-1},T_k,T_{k+1}$, for instance, there are several possible approximations to $\partial T/\partial z$ at points in $V$.  For reasons made clear by maximum principle arguments \citep[especially section 4.3]{MortonMayers}, we will do an \emph{upwind} approximation, in particular starting with a first-order approximation to $\partial T/\partial z$, which preserves the stability of the advection scheme as long as the CFL condition holds \citep[section 4.2]{MortonMayers}.  In the present finite-volume style of presentation, the upwinding we choose corresponds to evaluating the derivatives of $T$ at the center of the face determined by the sign of the coefficient velocity (e.g.~in the advection term $u\,\partial T/\partial x$) instead of at the center of $V$.  The velocity itself is evaluated at the center of $V$.  Let $u_{ijk}$ approximate $u(x_i,y_j,z_k,t)$, and similarly for the other components of velocity.  Then
\begin{align*}
\int_V \bU \cdot \grad T &= \int_V u \ddx{T} + v \ddy{T} + w \ddz{T}\\
    &\approx \left[\Up(T_{\bullet,j,k} \big|u_{ijk}) + \Up(T_{i,\bullet,k} \big|v_{ijk}) + \Up(T_{i,j,\bullet} \big|w_{ijk})\right] \Delta x \Delta y \Delta z_k
\end{align*}
Recall from section \ref{numsect} that upwind notation (and its special case for vertical derivatives) is
    $$\Up(f_\bullet\big|\vf) = \begin{cases} \vf(f_i-f_{i-1})/\Delta x, & \vf\ge 0 \\ \vf(f_{i+1}-f_i)/\Delta x, & \vf< 0\end{cases}$$
with non-equally-spaced vertical case
    $$\Up(f_\bullet\big|\vf) = \begin{cases} \vf(f_k-f_{k-1})/(z_{k+1}-z_k), & \vf\ge 0 \\ \vf(f_{i+1}-f_i)/(z_k-z_{k-1}), & \vf< 0.\end{cases}$$
Higher order upwinding \citep{PayneDongelmans} is possible.  It is desirable if it can be shown to be more accurate without sacrificing stability, or to be comparably accurate but with more relaxed CFL condition.  See \citep{BBL} for a discussion of the CFL condition in the context of thermocoupled ice flow.

Incorporating the above into \eqref{conserveSIAfd}, and dividing by $\Delta x\Delta y\Delta z_k$, we have
\begin{align}
\rho_I c_I \ddt{T_k} &= \left(\dot\eps_{ij} \sigma_{ij}\right)_k + \frac{k_I}{\Delta z_k} \left(\frac{T_{k+1}-T_k}{z_{k+1}-z_k} - \frac{T_k-T_{k-1}}{z_k-z_{k-1}}\right) \label{temperatureSIAfd}\\
    &\quad - \rho_I c_I \left[\Up(T_{\bullet,j,k} \big|u_{ijk}) + \Up(T_{i,\bullet,k} \big|v_{ijk}) + \Up(T_{i,j,\bullet} \big|w_{ijk})\right]. \notag
\end{align}
Note we have arrived at a particular form of the second derivative of $T$ in the non-equally-spaced vertical grid case.  Equation \eqref{temperatureSIAfd} is a spatial semi-discretization of the conservation of energy.  In this section we will stop at this form, but in section \ref{numsect} we will also discretize in time and get an actual numerical method.  For ice shelves and streams, formula \eqref{temperatureSIAfd} has approximate strain-heating term
\begin{equation}\label{icestreamstrainheatrule}
\left(\dot\eps_{ij} \sigma_{ij}\right)_k = 4 \nu_k \left({\dot\eps_{xx,k}}^2 + {\dot\eps_{yy,k}}^2 + \dot\eps_{xx,k} \dot\eps_{yy,k} + {\dot\eps_{xy,k}}^2\right)
\end{equation}
where
    $$\dot\eps_{xx,k} = \frac{u_{i+1,jk} - u_{i-1,jk}}{2\Delta x}, \qquad\dot\eps_{yy,k} = \frac{v_{i,j+1,k} - v_{i,j-1,k}}{2\Delta y},$$
    $$\dot\eps_{xy,k} = \frac{1}{2}\left(\frac{u_{i,j+1,k} - u_{i,j-1,k}}{2\Delta y} + \frac{v_{i+1,jk} - v_{i-1,jk}}{2\Delta x}\right).$$
That is, for evaluating the strain heating we approximate strain rates by differencing values of the velocities on the regular grid; there is no reason to ``upwind'' because nothing is being transported.  These difference quotients result in a corresponding approximation $\dot\eps_k$ of the effective strain rate $\dot\eps$ at the center of the segment.  Thereby we define $\nu_k = \nu(T_k,\dot\eps_k,P_k)$.

The corresponding equation for a generic segment in rock is straightforward:
\begin{equation}
\rho_R c_R \ddt{T_k} = \frac{k_R}{\Delta z_k} \left(\frac{T_{k+1}-T_k}{z_{k+1}-z_k} - \frac{T_k-T_{k-1}}{z_k-z_{k-1}}\right). \label{temperatureROCKfd}
\end{equation}
The segment at the ice/rock interface will be addressed separately below.

\subsection*{Approximation at top and bottom of the column (boundary conditions)}  Of the segment cases shown in figure \ref{fig:segments}, we have dealt with the generic ice and generic rock cases.  Now we consider the upper and lower boundary conditions on the column.  The upper end is trivial because we have a Dirichlet condition
\begin{equation}\label{topDirichlet}
T_{k_{\max}}(t) = T_s(t).
\end{equation}

At the lower end of the column we apply the geothermal flux $\bq_{\text{geothermal}} = G \khat$ \emph{to the bottom of the lowest segment}.  That is, \eqref{conserveROCK} becomes
\begin{equation*}
\rho_R c_R \int_V \ddt{T} = k_R \int_{S^+} \grad T \cdot \nhat - \int_{S^-} \bq_{\text{geothermal}} \cdot \nhat = k_R \int_{S^+} \grad T \cdot \nhat + \int_{S^-} G
\end{equation*}
where $V$ is a segment which extends from staggered grid point $\zeta_1$ to an imaginary additional staggered grid point $\zeta_{0}$ a distance $\zeta_1 - z_0$ \emph{below} the bottom $z=z_0$ of the column.  That is, we apply the geothermal flux on a horizontal surface $S^-$ which is located at $z=z_0 - (\zeta_1-z_0)$.  The resulting approximation is
\begin{equation}
\rho_R c_R \ddt{T_0} = \frac{1}{2(\zeta_1-z_0)} \left(k_R \frac{T_{1}-T_0}{z_{1}-z_0} +G\right). \label{tempbclowerROCKfd}
\end{equation}

If there happens to be no bedrock, which is to say if $z_0=z_\ast$ in figure \ref{fig:verticalgrid}, then equation \eqref{tempbclowerROCKfd} \emph{should be disregarded} and equations \eqref{acrossINTERFACEfd} and \eqref{norockREPLACEfd} below should be substituted.  In such a case of no modelled heat storage in bedrock, the geothermal flux applies at the ice-rock interface where there are also contributions from basal frictional heating, the latent heat of melt water, and a not-quite-obvious advection term.  We address these contributions below.

\subsection*{Melting}  To account for melting within the ice and to derive a reasonable evolution scheme for melting which accounts for the substantial latent heat of melt water, we must return to equation \eqref{mostgeneral} and reconsider the expression for the thermal energy contained within a segment of ice.  The version in equation \eqref{mostgeneral}, as noted at the time, assumed that all heat energy was sensible, whereas now we will include the latent heat of the melted fraction of the ice.

Dropping our volume $V$ for the moment, let us reconsider a mass $m$ of \emph{cold} ice.  A reasonable expression for the absolute (thermal) energy of this mass is
    $$E = \int_{0}^T m \tilde c_I(T)\,dT$$
where $T$ is in Kelvin and $\tilde c_I(T)$ is the temperature-dependent specific heat of ice.  We actually use a constant value $c_I$ for the specific heat of ice which applies the temperature range relevant to ice sheet modeling, however.  That is, we approximate
\begin{equation}\label{approxabsthermal}
E = \int_{0}^{T_{\min}} m \tilde c_I(T)\,dT + \int_{T_{\min}}^T m \tilde c_I(T)\,dT\approx E_{T_{\min}} + c_I (T-T_{\min}),
\end{equation}
where $T_{\min} = 223.15 \,\text{K} = - {50}^\circ\, \text{C}$, for example, and $E_{T_{\min}} = \int_{0}^{T_{\min}} m \tilde c_I(T)\,dT$ by definition.  We will never know or care about the value of $E_{T_{\min}}$ because it is simply a universal energy offset.  Our particular constant value $c_I = 2009\, \text{J}\, \text{kg}^{-1}\, \text{K}^{-1}$ for the specific heat of ice can be seen as a reasonable average for $\tilde c_I(T)$ for $223 \le T \le 273$ \citep[compare][page 205]{Paterson}.  From now on we will forget that \eqref{approxabsthermal} is an approximation.

The expression used in equation \eqref{mostgeneral} was perfectly adequate for our purpose at the time, which was to compute $\partial T/\partial t$.  Let us assume, however, that a particular segment of the column, of mass $m$, is at the pressure-melting temperature $\Tpmp$.  Consider the fraction $\omega$ of this mass is melted.  The new energy is
    $$E = E_{T_{\min}} + c_I (\Tpmp-T_{\min}) + \omega m L$$
where $L = 335 \times 10^3 \,\text{J}\,\text{K}^{-1}$ is the latent heat of fusion.  Note here that if we increase the energy of the mass, but not enough to fully melt it, and if the pressure on the mass does not change so $\Tpmp$ is constant, then the melt fraction must change as it is the only variable.

One result of melting in the column of grounded ice is a build-up of a thin layer of water at the base.  We assume that the mass, volume, and momentum of this water are insignificant, but we will conserve its stored latent heat.  We define
    $$H_{\text{melt}}(x,y,t)$$
as the ice-equivalent thickness in meters of the basal water layer.  The layer gives a latent heat energy density in the map-plane of $L \rho_I H_{\text{melt}}$; as a energy density it has units of Joules per square meter.  This energy is available for heating the base through refreezing, which will thin the layer.  This energy will be able to keep the ice/rock interface lubricated even when the strain-heating within the column, and frictional heating at the base, for example, are low enough to not be causing active melting.  The latent heat energy of the basal melt water will be incorporated into the energy balance for a segment across the ice-rock interface; below.  Note that $H_{\text{melt}}$ takes up no space at the bottom of the column, and the water represented by $H_{\text{melt}}$ is not transported by the sliding ice; conceptually it is bound in till.

In this subsection we make four simplifying assumptions:\renewcommand{\labelenumi}{\emph{\roman{enumi}}) }
\begin{enumerate}
\item the melt fraction within an ice segment is small enough ($0\le \omega \ll 1$) so that the density of the ice/water mixture can be taken to be exactly that of ice \citep{Greve};
\item the temperature $T$ and the local melt fraction $\omega$ are assumed spatially constant within a segment $V$ (e.g.~for the purpose of computing energy content);
\item some melt water can be transported to the base of the column on a short timescale; it adds to $H_{\text{melt}}$;
\item we will not conserve the latent heat of the melt fraction in a segment above the ice base.
\end{enumerate}

From the first assumption above we may compute the energy within a partially-melted segment $V$ by
    $$E = E_{T_{\min}} + \int_V \rho_I c_I (\Tpmp-T_{\min}) + \int_V L \rho_I \omega.$$
(The mass of this segment is $m=\int_V \rho_I$.)  Differentiating this with respect to time, and from the second assumption,
\begin{equation*}
\DDt{E} = L \ddt{}\left(\text{mass of melted water}\right) \approx L \rho_I \Delta x\Delta y \Delta z_k \ddt{\omega}
\end{equation*}
for a (generic, i.e.~not across the ice-rock interface) partly-melted ice segment.  Recall that conservation of energy is the statement
    $$\DDt{E} = \mathcal{I} - \int_{\partial V} \bq \cdot \nhat.$$
This conservation of energy statement will no longer predict a rate of temperature change, once we compute the terms on the right, but rather a rate of change of the melt fraction.

Our approximation to conservation of energy for a (generic) partially-melted ice segment is thus equation \eqref{temperatureSIAfd} with left side replaced by $\rho_I L \partial\omega/\partial t$.  In particular, if the ice in segment $V$ with center $z_k$ is already at the pressure-melting temperature, then the mass melted in a time step $\Delta t$ is computed by
\begin{align}
\Delta m_{\text{melt},k} = (\text{mass of }&\text{segment})(\text{fraction melted in }\Delta t) = (\rho_I \Delta x\Delta y \Delta z_k)\left(\ddt{\omega}\Delta t\right) \label{massmelted} \\
    = \frac{\Delta x\Delta y \Delta z_k\Delta t}{L} \Big\{&\left(\dot\eps_{ij} \sigma_{ij}\right)_k + \frac{k_I}{\Delta z_k} \left(\frac{T_{k+1}-T_k}{z_{k+1}-z_k} - \frac{T_k-T_{k-1}}{z_k-z_{k-1}}\right) \notag\\
    &- \rho_I c_I \left[\Up(T_{\bullet,j,k} \big|u_{ijk}) + \Up(T_{i,\bullet,k} \big|v_{ijk}) + \Up(T_{i,j,\bullet} \big|w_{ijk})\right]\Big\}. \notag
\end{align}
Reading this may be easier if one notes that the expression in curly parentheses is $dE/dt$ divided by the volume $\Delta x\Delta y \Delta z_k$.

Equation \eqref{massmelted} only applies if its right-hand side is nonnegative, however.  If the right-hand side is negative then equation \eqref{temperatureSIAfd} should be applied, which then predicts that the temperature falls below $\Tpmp$.  Note that by assumption \emph{iv}) above, we particularly mean that $\omega=0$ is the melt fraction at the beginning of each time step.

Indeed, consider assumptions \emph{iii}) and \emph{iv}).  We move some of the melted water, just computed by \eqref{massmelted}, instantly to the base.  Consider a segment $V$ with center $z_k$.  By ``some'' of the water being transported to the base we mean the rules: \begin{itemize}
\item If $z_k \ge 100$ (m) then the contribution to the basal water layer is zero regardless of the sign of $\Delta m_{\text{melt},k}$; this melt water is lost entirely and cannot refreeze.
\item If $0 < z_k < 100$ and if the mass $\Delta m_{\text{melt},k}$ computed by the above rule is \emph{positive} then the contribution to $H_{\text{melt}}$ is $[0.4 (100 - z_k)/ 100]\,\Delta m_{\text{melt},k}$.  That is, at most $40\%$ of the water is transported to the base, and the fraction is linearly increasing from $0\%$ at $100$ meters up to $40\%$ at the base.
\item If $0 < z_k < 100$ and if the mass $\Delta m_{\text{melt},k}$ computed by the above rule is \emph{negative} then the contribution to $H_{\text{melt}}$ is zero; refreezing does not happen above the base.
\item If $z_k=0$, that is for the ice/rock interface segment, the basal water layer $H_{\text{melt}}$ is part of the energy balance; see below.\end{itemize}

Note that ``instant'' transport of the water to the base violates the fundamental Eulerian nature of our segments.  The only way to do transport in an Eulerian-and-finite-volume scheme would require many time steps: one would transport mass across upper and lower faces of vertically-adjacent segments in order to get the melt water to the bottom after some number of steps.

Thus we have a contribution
    $$\Delta H_{\text{melt}} = \frac{1}{\rho_I \Delta t\Delta x \Delta y}\cdot \sum_{\left(\begin{smallmatrix}\text{melted segments such} \\  \text{that }0<z_k<100 \text{ and} \\ \text{such that } \Delta m_{\text{melt},k} > 0\end{smallmatrix}\right)}  0.4 \frac{100 - z_k}{100} \Delta m_{\text{melt},k}$$
from the segments above the base.  See the next subsection for the total basal melt rate, which includes melting or refreezing in the ice/rock interface segment, and for its contribution to the vertical velocity.

In practice we propose to limit the magnitude of $H_{\text{melt}}$ to (for instance) 10 meters, and to assume that any additional water is transported to the edge of the ice sheet and that its energy is no longer available for refreezing.  Certainly one would not want the water to build up to such a level that the base is permanently ``inoculated'' against refreezing.  The basal water in excess of our 10 meter cut-off, conceptually speaking, instantly leaks out to the edge of the ice sheet through an unspecified network of basal channels.


\subsection*{A segment across the ice-rock interface} We have delayed discussing this special segment because \emph{everything} happens here all at once.  In particular, we must take into account all of the following features: non-constant material properties, conduction, advection, strain-heating, basal frictional heating, and the latent heat of basal water.

Recall equation \eqref{general} for energy conservation in a segment.  In a segment \emph{across} the ice/rock interface, only the upper part is flowing.  Also, when there is sliding at the ice/rock interface the velocity field is not defined there (i.e.~on the basal plane $z=z_\ast$) and there is a infinite concentration of heating (infinite as a \emph{per volume} heating density, that is).  This suggests that we return temporarily to the earlier form, equation \eqref{mostgeneral}, with flux integral through the sides for the advection fluxes, in order to analyze this case.  We use the notation shown in figure \ref{fig:segINTERFACE}.  We will assume that all liquid water in this special segment is contained in the basal layer $H_{\text{melt}}$.  In particular, there will be no ice/water mixture in the volume $V^+$, and we will not keep track of a melt fraction for this or any other segment.

The equation of conservation of energy for the whole segment $V=V^+\cup V^-$ is
\begin{align}
\ddt{}\Big(\rho_I c_I \int_{V^+} T &+ \rho_R c_R \int_{V^-} T + \int_{S^\ast} L \rho_I H_{\text{melt}}\Big) \label{acrossINTERFACE} \\
    &= \int_{V^+} \dot \eps_{ij} \sigma_{ij} + \int_{S^\ast} (-\tau_b) \cdot \bU_b + \int_{S^+} k_I \grad T \cdot \nhat + \int_{S^-} k_R \grad T \cdot \nhat \notag\\
    &\qquad - \rho_I c_I\left(\int_{S^+} T \bU\cdot \nhat + \int_{(\text{sides})^+} T \bU\cdot \nhat\right).\notag
\end{align}
The only advection fluxes which are included are those which could be nonzero, i.e.~those on the \emph{ice} (and not rock) faces of the segment.  Note that the basal plane $S^\ast$ is not a surface of $V$ and is not included, and also that the velocity field $\bU$ is not \emph{a priori} defined on $S^\ast$.  Note $\tau_b$ is the vector basal shear stress with sign chosen so that
    $$(\text{basal frictional heating}) = -\tau_b \cdot \bU_b \ge 0$$
\citep[chapter 10]{Paterson}.  For instance, at inland ice sheet points we use $\tau_b = \rho_I g H \grad h$, but in ice streams we use the basal drag term which appears in the equations for ``dragging ice shelves'' \citep[i.e.~the equations from][]{MacAyeal}.

\begin{figure}[ht]
\regfigure{interfacesegment}{3.5}
\vspace{-0.1in}
\caption{A special segment $V=V^+\cup V^-$ across the ice-rock interface.  There may be sliding, and thus basal frictional heating and a thin layer of basal melt water, in the plane $z=z_\ast$.  Advection heat fluxes and bulk strain-heating only occur in the ice $V^+$ and not in the rock $V^-$.}
\label{fig:segINTERFACE}
\vspace{-0.1in}
\end{figure}

The advection flux integrals through the ice parts of the surface of $V$ suggest a different approach from the generic ice or generic rock cases.  In fact, consider the last two integrals in equation \eqref{acrossINTERFACE}, which are over the top surface of the segment and the parts of its sides which are ice, respectively.  We approximate these integrals by integrating strictly above the basal plane by distance $\eps>0$  and then letting $\eps\to 0$.  Define
    $$V_\eps^+ = \{z > z_\ast+\eps\} \cap V^+,$$
and define $S_\eps$ to be the horizontal lower surface of $V_\eps^+$: $S_\eps = \{z = z_\ast + \eps\} \cap V^+$.  The integrals in question are computed by adding and subtracting the surface $S_\eps$, and by using the divergence theorem:
\begin{align*}
\int_{S^+} T \bU\cdot \nhat + \int_{(\text{sides})^+} T \bU\cdot \nhat &= \int_{\partial V_\eps^+} T \bU\cdot \nhat - \int_{S_\eps} T \bU\cdot (-\khat) + \int_{z_\ast}^{z_\ast+\eps} T \bU\cdot \nhat \\
    &= \int_{V_\eps^+} \Div\left(T\bU\right) + \int_{S_\eps} T w + \int_{z_\ast}^{z_\ast+\eps} T \bU\cdot \nhat \\
    &= \int_{V_\eps^+} \bU\cdot \grad T + \int_{S_\eps} T w + \int_{z_\ast}^{z_\ast+\eps} T \bU\cdot \nhat.
\end{align*}
The last equality follows from incompressibility $\Div\bU=0$.  The last integral from $z_\ast$ to $z_\ast + \eps$ above is the advection flux integral through the parts of the ice sides which are below $S_\eps$, that is, the parts of the side just above and within $\eps$ of $S^\ast$.  Because $\bU$ and $T$ are everywhere bounded, the $\eps \to 0$ limit is
\begin{equation}\label{advectfluxINTERFACE}
\int_{S^+} T \bU\cdot \nhat + \int_{(\text{sides})^+} T \bU\cdot \nhat = \int_{V^+} \bU\cdot \grad T + \int_{S^\ast} T w.
\end{equation}
Note that $w$ is thereby defined on $S^\ast$ by
    $$w(z_\ast) := \lim_{z\searrow z_\ast} w(z),$$
which can be nonzero if there is basal melting.

The first integral in \eqref{advectfluxINTERFACE} is one we already know how to approximate by upwinding.  It is appropriate to simplify the vertical upwinding in this case by noting that $w$ is always nonpositive on $S^\ast$.  (It is either zero if the base is frozen or negative if there is basal melting.  In fact it could be positive from refreezing of basal melt water, but as noted we are not conserving the water in this sense.)  We can now approximate \emph{the right-hand side} of \eqref{acrossINTERFACE}:
\begin{align}
\big(\text{rate }&\text{of change of thermal energy in }V\big) \label{acrossINTERFACEfd}\\
    &= (\dot\eps_{ij} \sigma_{ij})_k \Delta x \Delta y (\zeta_+ - z_\ast) - P_\ast \grad h \cdot \bU_b \Delta x \Delta y \notag\\
    &\quad + k_I \frac{T_{\ast+1}-T_\ast}{z_{\ast+1}-z_\ast} \Delta x \Delta y  - k_R \frac{T_{\ast}-T_{\ast-1}}{z_{\ast}-z_{\ast-1}} \Delta x \Delta y \notag\\
    &\quad - \rho_I c_I \left[\Up(T_{\bullet,j,\ast} \big|u_{ij\ast}) + \Up(T_{i,\bullet,\ast} \big|v_{ij\ast}) + w_{ij\ast} \frac{T_{\ast+1}-T_\ast}{z_{\ast+1}-z_\ast}\right] \Delta x \Delta y (\zeta_+ - z_\ast). \notag \\
    &\quad - \rho_I c_I T_\ast w_\ast \Delta x \Delta y. \notag
\end{align}

If there is no simulation of heat storage in the bed, that is if bedrock is not ``present,'' we propose to include it a little bit of it anyway by a modification of the above argument.  Namely, we do the same analysis of which leads to \eqref{acrossINTERFACE} but to replace the conduction flux integral in the rock with the geothermal flux:
    $$\int_{S^-} k_R \grad T \cdot \nhat \quad\to\quad \int_{S^-} (-G\khat) \cdot \nhat = \int_{S^-} G$$
so
\begin{equation}\label{norockREPLACEfd}
- k_R \frac{T_{\ast}-T_{\ast-1}}{z_{\ast}-z_{\ast-1}} \Delta x \Delta y \quad\to\quad + G \Delta x \Delta y
\end{equation}
in equation \eqref{acrossINTERFACEfd}.  Note that the modified version of \eqref{acrossINTERFACEfd} for this case still depends on $\rho_R$, $c_R$, and $k_R$.  Thus material properties of the bed still matter, but we believe this is consistent with the physics of the situation.  For instance, the amount of heat from basal friction which enters the ice is in part controlled by how much is lost to the bed, even if we assume no ``heat storage'' in the bed.  (Note that ignoring heat storage in the bed is equivalent to assuming $k_R\partial T/\partial z = -G$ at every point within the bedrock.  If desired one can artificially set the material properties of rock to those of ice for purposes like verification \citep{BBL} or certain simplified experiments \citep{EISMINT00}.)

Now, what is the ``rate of change of thermal energy in $V$'' in equation \eqref{acrossINTERFACEfd}?  First of all, in all cases we impose the rigid rule
    $$H_{\text{melt}} > 0 \qquad \iff \qquad T_\ast = \Tpmp.$$
Consider the cold case: suppose $H_{\text{melt}} = 0$ and $T_\ast < \Tpmp$.  In this case the energy of the segment $V$ can increase by an increase in $T_\ast$, the representative temperature in $V$.  That is, our approximation is
\begin{align*}
\left(\text{rate of change of thermal energy in }V\right) &= \left[\rho_I c_I (\zeta_+ - z_\ast) + \rho_R c_R (z_\ast - \zeta_-)\right] \ddt{T_\ast} \Delta x \Delta y,
\end{align*}
which is then equal to the quantity computed in \eqref{acrossINTERFACEfd}.  That is, we determine the rate of change of the basal temperature.  It is possible that at the end of a time step, in this case, the temperature could reach or exceed $\Tpmp$.  In this case we determine $H_{\text{melt}}$ by the amount of melting equivalent to the temperature difference $T_\ast - \Tpmp$.  In the other case, where $H_{\text{melt}} > 0$,
\begin{align*}
\left(\text{rate of change of thermal energy in }V\right) &= L \rho_I \ddt{H_{\text{melt}}} \Delta x \Delta y.
\end{align*}
If the resulting predicted $H_{\text{melt}}$ is negative then we set $H_{\text{melt}} = 0$ and $T_\ast=\Tpmp - 10^{-3}\,\text{K}$.  If the predicted $H_{\text{melt}} > 0$ then we accept it and set $T_\ast=\Tpmp$.


We also make the following rule for the basal value of the vertical velocity in the given column:
    $$w(z_\ast) = - \ddt{H_{\text{melt}}}.$$
Recall that $z=z_\ast$ is the level of the ice-rock interface.  We use $w(z_\ast)$ as the starting value in the vertical integral which computes the vertical velocity (i.e.~from incompressibility).  The same contribution is made to the rate of change of the ice thickness in solving the mass-continuity equation.  These contributions of basal melt rate to ice flow can be turned off in PISM.



\subsection*{On the base of a column in an ice shelf}  Let's suppose the ice column is floating.  In this case the bedrock is, of course, physically separated from the bedrock, as shown in figure \ref{fig:floatingcase}.  The temperature in the bedrock is not important in this case.  A convenient implementation has every column taking the same amount of computer memory.  Thus we have only one memory location for two locations, the bottom of the floating ice and the top of the bedrock.

\begin{figure}[ht]
\regfigure{floatingcase}{3}
%\vspace{-0.1in}
\caption{If the ice is floating then the bedrock is thermally decoupled.  In this case a single value $T_\ast$ gives the temperature for both the base of the ice and the top of the bedrock.  We apply a hypothesized ocean heat flux $G_{\text{ocean}}$ to the base of the ice \emph{and} we set $T_\ast = \Tpmp = T_0 - \beta H$.}
\label{fig:floatingcase}
\end{figure}

As a default, in absence of a ocean model which can provide more complete and more physical boundary conditions, we hypothesize a known ocean heat flux applied to the base of the ice.  On the other hand, the temperature of the base of the floating ice is the pressure melting temperature $T_\ast = \Tpmp = T_0 - \beta H$.  (Note that the pressure at the base of the ice can be determined ``hydrostatically'' within the ice or genuinely hydrostatically: $P_\ast = \rho_I g H = \rho_w g \left[(\rho_I/\rho_w) H\right]$, where $\rho_w$ is the density of sea water.  Note $-(\rho_I/\rho_w) H$ is the depth of the base of the ice below sea level.)

For a solid material this would be an over-determined problem, with both the temperature and its gradient set at the boundary.  In our case, however, we use the ocean heat flux entirely to determine the basal melt rate.  That is, the conservation of energy statement is
\begin{align}
L \rho_I \int_{S^\ast} \ddt{H_{\text{melt}}} &= \int_{V^+} \dot \eps_{ij} \sigma_{ij} + \int_{S^+} k_I \grad T \cdot \nhat + \int_{S^\ast} G_{\text{ocean}} \label{basefloating}\\
    &\qquad - \rho_I c_I\int_{V^+} \bU\cdot \grad T.\notag
\end{align}
using the notation of the previous subsection.  In particular, $V^+ = \{z_\ast < z < \zeta_+\}$, $S^+ = \{z=\zeta_+\}$, and $S^\ast = \{z=z_\ast\}$.  Note that there is no actual layer of basal melt water; we denote the basal melt rate $\partial H_{\text{melt}}/\partial t$ to suggest the method of computation, which is to compute the basal melt rate as $\Delta H_{\text{melt}}/\Delta t$ and then reset $H_{\text{melt}}=0$ at the end of every time step.

\subsection*{Caveats on marginal points}  Unfortunately we observe that near the margin the thermocoupled flow is badly behaved.  For cold enough ice, with minimal strain heating near the margin, this does not cause excessive numerical difficulties \citep{BBL}.  For realistic margins, however, there are very strong temperature gradients and strain-heating near the margin.  There are also irregularities in the vertical velocity and the basal melt rate.

A better way of computing the surface gradient and certain other quantities near the margin is offered by \citet{SaitoMargin}.  They recommend differencing upstream into the ice sheet.  We have not yet implemented this.

For now we have the following \emph{ad hoc} mechanism.  If a grid point has any horizontal neighbors where the ice is thin, defined as $H < 100$ m, then only the conduction part of the conservation of energy is used.  The advection and strain-heating terms are dropped.

% following problem may have resulted from a bug in the geothermal flux condition at the base of the bedrock:
%Even with this convention we still find bad behavior with the basal melt mechanism.  There seems to be some kind of basal melt runaway.  Thus, to avoid this problem, and \emph{not} just because the modeled basal melt rate is always small \citep[compare the dismissal in][]{EISMINT00}, one usually runs PISM with the contribution of basal melt rate to vertical velocity and to map-plane mass continuity removed.


\section{Constants and Defaults}

In this section we document constants and defaults in an expedient, but not terribly readable manner.  We include the files \texttt{materials.hh} and \texttt{materials.cc} in which physical constants for PISM are set.  We also include \texttt{iMdefaults.cc} which includes a number of additional default settings.

\subsection*{materials.hh}  Here we define the structure of three types of materials: ice, bedrock, and ocean.

\scriptsize
\begin{quote}
\verbatiminput{../src/materials.hh}
\end{quote}
\normalsize

\subsection*{materials.cc}  Here we fill in the actual physical constants.  Note that for flow laws we have both forms $\dot \eps_{ij} = F(T,\sigma',P) \sigma_{ij}'$ and $\sigma_{ij}' = 2 \nu(T,\sigma',P) \dot \eps_{ij}$, but that the latter is already in vertically-integrated form as needed for MacAyeal-Morland equations.

\scriptsize
\begin{quote}
\verbatiminput{../src/materials.cc}
\end{quote}
\normalsize

\subsection*{iMdefaults.cc}  These are defaults used in \texttt{pismr}.  The variables set here are not saved as part of the model state.  Options can be used to override all of these; see the \emph{User's Manual}.  The verification tests and simplified geometry experiments run by \texttt{pismv} and \texttt{pisms}, respectively, override some of these; see \texttt{iceCompModel.[hh|cc]}, \texttt{iceEISModel.[hh|cc]}, and \texttt{iceHeinoModel.[hh|cc]}, in particular.

\scriptsize
\begin{quote}
\verbatiminput{../src/iMdefaults.cc}
\end{quote}
\normalsize

\newpage
\bibliography{ice_bib}
\bibliographystyle{igs}

\end{document}
