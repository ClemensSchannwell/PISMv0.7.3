\documentclass[titlepage,letterpaper,final]{scrartcl}

\usepackage{scrindex}           % multiple index support using the "index" package

%% THE FOLLOWING SHOULD CHANGE FOR A STABLE RELEASE:
\newcommand{\PISMREV}{\textbf{trunk} revision \input{revision.tex}}
\newcommand{\PETSCREL}{2.3.3 or 3.0.? or 3.1.?}
\newcommand{\PISMDOWNLOADMSG}{Get development version of PISM source code: \quad\texttt{svn co http://svn.gna.org/svn/pism/trunk pism-dev} \quad}

%\addtolength\topmargin{-.1in}
\addtolength\textheight{0.4in}
\addtolength{\oddsidemargin}{-.4in}
\addtolength{\evensidemargin}{-.4in}
\addtolength{\textwidth}{0.9in}
\newcommand{\normalspacing}{\renewcommand{\baselinestretch}{1.1}\tiny\normalsize}
\newcommand{\tablespacing}{\renewcommand{\baselinestretch}{1.0}\tiny\normalsize}
\normalspacing

\usepackage[usenames]{xcolor}

\usepackage{bm,url,xspace,verbatim}
\usepackage{amssymb,amsmath}
\usepackage[pdftex]{graphicx}


\usepackage{booktabs}           % better rules in tables
\usepackage{xtab}               % long (multi-page) tables

%% uncomment to see locations of index entries
% \proofmodetrue

\usepackage{underscore}

% this lets us avoid the scrartcl/hyperref conflict...
\let\ifvtex\relax

% hyperref should be the last package we load
\usepackage[pdftex,
                colorlinks=true,
                plainpages=false, % only if colorlinks=true
                linkcolor=blue,   % only if colorlinks=true
                citecolor=blue,   % only if colorlinks=true
                urlcolor=blue     % only if colorlinks=true
]{hyperref}[2010/03/30 v6.80u Hypertext links for LaTeX]

\newcommand{\ddt}[1]{\ensuremath{\frac{\partial #1}{\partial t}}}
\newcommand{\ddx}[1]{\ensuremath{\frac{\partial #1}{\partial x}}}
\newcommand{\ddy}[1]{\ensuremath{\frac{\partial #1}{\partial y}}}
\renewcommand{\t}[1]{\texttt{#1}}
\newcommand{\Matlab}{\textsc{Matlab}\xspace}
\newcommand{\bq}{\mathbf{q}}
\newcommand{\bU}{\mathbf{U}}
\newcommand{\eps}{\epsilon}
\newcommand{\grad}{\nabla}
\newcommand{\Div}{\nabla\cdot}

%% macros having to do with documentation for options; note these appear in the index

\newindex{default}{idx}{ind}{General Index}
\newindex{options}{odx}{ond}{PISM Command-line options}

\def\optsection#1{%
  \def\optindex##1{\index[options]{#1!##1}}
  \def\optseealso##1{\index[options]{#1|see{##1}}}
}

\optsection{FIXME}

% Use this to index option definitions:
\newcommand{\intextoption}[1]{\texttt{-#1}\optindex{\texttt{-#1}}}

\newcommand{\txtopt}[2]{\texttt{-#1} #2\optindex{\texttt{-#1} #2}}

\newcommand{\listopt}[1]{\txtopt{#1}{\emph{comma-separated list}}}
\newcommand{\fileopt}[1]{\txtopt{#1}{\emph{filename}}}
\newcommand{\timeopt}[1]{\txtopt{#1}{\emph{range or list}}}

\newcommand{\rawopt}[1]{\vspace{1mm}\noindent \Large\texttt{-#1}\normalsize\optindex{\texttt{-#1}}}
\newcommand{\opt}[1]{\rawopt{#1}\,:\quad}
\newcommand{\optdef}[2]{\rawopt{#1}\,[\textsl{#2}]:\quad}
\newcommand{\optrestrict}[2]{\rawopt{#1}\,[\texttt{#2} \textsl{only}]:\quad}
\newcommand{\optdefrestrict}[3]{\rawopt{#1}\,[\textsl{#2}]\,[\texttt{#3} \textsl{only}]:\quad}


\pdfinfo{
/Title (PISM User's Manual)
/Author (Ed Bueler and Constantine Khroulev and Andy Aschwanden and Jed Brown and Nathan Shemonski)
/Subject (Using PISM, a Parallel Ice-Sheet Model)
/Keywords (PISM ice sheet modeling)
}

\begin{document}
\graphicspath{{figs/}}

\begin{titlepage}
  \begin{center}
    {\huge\usekomafont{title} \emph{PISM}, a Parallel Ice Sheet Model:\\\medskip User's Manual}
    \vspace{1cm}

    {\Large Ed Bueler \\ Constantine Khroulev \\ Andy Aschwanden \\ Jed Brown \\ Nathan Shemonski}
    \vspace{1cm}

    \includegraphics[width=3.in,keepaspectratio=true]{grn-grl-csurf}
    \vfill

    \small Support by email: \texttt{help\@@pism-docs.org}. 

    Manual date \today. Based on PISM \PISMREV.  Needs PETSC release \PETSCREL. \PISMDOWNLOADMSG
  \end{center}
\end{titlepage}

\phantom{bob}
\vspace{1.0in}
\begin{quote}
\textsl{Copyright (C) 2004--2010 Ed Bueler and Constantine Khroulev and Andy Aschwanden and Jed Brown and Nathan Shemonski}
\medskip

\noindent \textsl{This file is part of PISM.}
\medskip

\noindent \textsl{PISM is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  PISM is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License\index{GPL (\emph{GNU Public License})} along with PISM; see \emph{\texttt{COPYING}}.  If not, write to the Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA}
\end{quote}
\vspace{0.6in}
\normalspacing


\centerline{\textsc{Acknowledgements}}
\bigskip

\small
The NASA Modeling, Analysis, and Prediction program\index{NASA!Modeling, Analysis, and Prediction Program} (grant \# NNX09AJ38G) supports the development of PISM from 2009 to 2013.  We thank them!  Development from 2002 to 2008 was supported by the NASA Cryospheric Sciences Program\index{NASA!Cryospheric Sciences Program}.

The Snow, Ice, and Permafrost (SIP) group\index{Geophysical Institute!Snow, Ice, and Permafrost group} at the Geophysical Institute at UAF is now the home for PISM developers.  Find us in Elvey 410D, in a corner office facing the wilds of Alaska.

The Arctic Region Supercomputing Center\index{Arctic Region Supercomputing Center (ARSC)} has provided significant computational resources and technical help in the development of PISM.

Our research into ice sheet modeling was strongly influenced and constantly motivated by Craig Lingle\index{Lingle, Craig}.  Dave Covey, Don Bahls, and Greg Newby have supported our computers, tools, and and computations.  Martin Truffer, Regine Hock, Dani DellaGiustina and others in the SIP group provide the real-glaciology context for PISM at UAF.  Thanks to Tolly Adalgeirsdottir, Torsten Albrecht, Nick Golledge, Marianne Hasselhoff, Tore Hattermann, Jesse Johnson, Anders Levermann, Art Mahoney, David Maxwell, Maria Martin, Kent Overstreet, Ben Sperisen, Ward van Pelt, Ricarda Winkelmann, Ryan Woodard, Florian Ziemen and other PISM users/developers for helpful comments and questions on PISM and this \emph{Manual}.
\normalsize

\newpage
\setcounter{tocdepth}{3}
\small
\tableofcontents
\normalsize

\newpage


\section{Introduction}\label{sect:intro}

Welcome!  All information about PISM is online at
\begin{center}
  \href{http://www.pism-docs.org}{\t{www.pism-docs.org}}
\end{center}

This \emph{User's Manual} describes how to run PISM using certain publicly-available data for the Greenland ice sheet and the Ross ice shelf.  It illustrates how PISM's numerical approximations are verified.  It documents all the PISM options.  But it does not explain PISM internals, nor is it a guide for extending the functionality of PISM.

See the \emph{Installation Manual} for how to download\index{PISM!download source code} the PISM source code and install it\index{PISM!install}, along with needed libraries.  It is online at
   \begin{center}
     \href{http://www.pism-docs.org/dev/pdfs/installation-dev.pdf}{\t{www.pism-docs.org/dev/pdfs/installation-dev.pdf}}
   \end{center}

Users who want to understand how PISM works, extend PISM, and/or generally advance the science of ice sheets will need to go beyond what is described here.  For such users there is a \emph{C++ Class Browser}\index{PISM!\emph{C++ Class Browser (HTML)}}.  It gives a complete view of the class/object structure of the PISM source code.  It is the best tool for the job of modifying and supplementing PISM by writing derived classes.  It is online at
   \begin{center}
     \href{http://www.pism-docs.org/dev/doxy/html/index.html}{\t{www.pism-docs.org/dev/doxy/html/index.html}}
   \end{center}

\vspace{.5in}
  
\begin{center}
\includegraphics[width=3in,keepaspectratio=true]{rossquiver}
\end{center}

\vspace{.5in}
\large
\begin{center}
\framebox{\parbox{5.0in}{ \emph{WARNING}:\index{PISM!warning}  PISM is an ongoing project.  Ice sheet modeling is complicated and is generally not mature.  Please don't trust the results of PISM or any other ice sheet model without a fair amount of exploration.  Also, please don't expect all your questions to be answered here.  Write to us with questions at \href{mailto:help@pism-docs.org}{\texttt{help@pism-docs.org}}.} }
\normalsize
\end{center}
\normalsize


\clearpage\newpage
\input{getting-started.tex}


\clearpage
\newpage
\section{Ice dynamics, the PISM view}\label{sect:dynamics}

\subsection{PISM design principles}\index{PISM!principles}  This section gives an overview of ice dynamics models in PISM, but first we list some organizing principles:
\begin{enumerate}
\item source code should be open, free, and works well with other free software tools,
\item science is better if done with publicly-available data,
\item numerical methods should be verifiable (i.e.~we want comparisons to exact solutions of the modeled equations),
\item shallow models are (currently) the most effective at whole ice sheet scale,
\item comparing results from a hierarchy of ice dynamics simplifications is more important than getting them from any particular set of dynamical equations,
\item everything computed diagnostically (instantaneously) is available prognostically (i.e.~it can evolve in time), and
\item climate inputs should affect ice dynamics by a well-defined interface.
\end{enumerate}

\noindent We do not claim to follow these principles perfectly, but we hope that any user can see these principles reflected in PISM and this \emph{Manual}.

Principle 1 is illustrated by our existence.  Principle 2 is illustrated by examples in sections \ref{sect:start}, \ref{sec:eismint-greenland}, and \ref{sect:ross}.  Principle 3 is addressed in section \ref{sect:verif}.  Principles 4, 5, 6, and 7 are explained and expanded next.


\subsection{Two main shallow models, SIA and SSA}\index{PISM!SIA}\index{PISM!SSA}  At each time-step of a typical PISM run, the geometry, temperature, and basal strength of the ice sheet are included into stress (momentum) balance equations to determine the velocity of the flowing ice.   The ``full'' stress balance equations, namely the (non-Newtonian) Stokes model for slowly-flowing fluids \cite{Fowler}, are themselves an inertia-free approximation of the conservation of momentum equations.  Though PISM does not solve this ``full'' model, it can numerically solve two significantly-different shallow approximations of the full stress balance equations:\begin{itemize}
\item the non-sliding shallow ice approximation (SIA)\index{SIA (shallow ice approximation)} \cite{Hutter}, which describes ice as flowing by shear in planes parallel to the geoid, with an infinitely-strong contact of ice base to bedrock, and
\item the shallow shelf approximation (SSA)\index{SSA (shallow shelf approximation)} \cite{WeisGreveHutter}, which describes a membrane-type flow of floating ice \cite{Morland}, or grounded ice which is sliding over a weak base \cite{MacAyeal,SchoofStream}.
\end{itemize}
PISM solves both the SIA and SSA equations in parallel.  Time-stepping solutions of the mass continuity and energy conservation equations are possible when using each model.

The SIA\index{SIA (shallow ice approximation)!applicability} equations are, as a rule, easier and quicker to numerically solve than the SSA, and they are also easier to parallelize.\index{parallelization!relative ease of, between SIA and SSA}  They are a ``lubrication approximation'' \cite{Fowler} which describes the shear as a local function of the driving stress of classical glaciology \cite{Paterson}.  They can confidently be applied to those grounded parts of ice sheets for which the basal ice is frozen to the bedrock, or minimally sliding, and for which the bed topography is relatively slowly-varying in the map-plane \cite{Fowler}.  These characteristics apply to the majority \emph{by area} of the Greenland and Antarctic ice sheets.  We recommend solving the SIA with a \emph{non-sliding} base because the ad hoc addition of ``sliding laws''\index{SIA (shallow ice approximation)!sliding laws} into the SIA stress balance, and especially schemes which ``switch on'' at the pressure-melting temperature \cite{EISMINT00}, have bad continuum and numerical modeling consequences \cite[appendix B]{BBssasliding}.

The SSA\index{SSA (shallow shelf approximation)!applicability} equations can confidently be applied to large floating ice shelves, which have small depth-to-width ratio and negligible basal resistance \cite{Morland,MorlandZainuddin}.  Terrestrial ice sheets also have fast-flowing grounded parts, however, called ``ice streams'' or ``outlet glaciers''.  Such features appear at the margin of, and sometimes well into the interior of, the Greenland \cite{Joughinetal2001}\index{Greenland ice sheet} and Antarctic \cite{BamberVaughanJoughin}\index{Antarctic ice sheet} ice sheets.  Describing these faster-flowing grounded parts of ice sheets requires something more than the non-sliding SIA.  One might use the full Stokes equations, or a ``higher-order'' but still shallow stress balance \cite{Blatter,Pattyn03}, but with any stress balance model one must still specify an appropriate sliding boundary condition.  To address these faster-flowing parts, one may apply the SSA equations with additional basal resistance terms to model fast-flowing and sliding grounded ice.  This was demonstrated for the Siple Coast ice streams of Antarctica by MacAyeal\index{MacAyeal, Doug} \cite{MacAyeal} using a linearly-viscous model for the underlying till.  A free boundary problem with the same (SSA) balance equations is the Schoof\index{Schoof, Christian} \cite{SchoofStream} model of ice streams, in which ice streams appear where there is plastic basal till failure \cite{Paterson}.

Both the SIA and SSA models are \emph{shallow} approximations.  That is, the respective partial differential equations are derived from the Stokes equations by different small-parameter arguments, both based on a small depth-to-width ratio for the ice sheet.  For the small-parameter argument in the SIA case see \cite{Fowler}.  For the corresponding SSA argument, see \cite{WeisGreveHutter} or the appendices of \cite{SchoofStream}.  See \cite{SchoofHindmarsh} on connections between these shallowest models and ``higher order'' models.  For additional discussion of continuum equations for ice sheets, and for more on the physical motivation behind shallow modeling, see \cite{GreveBlatter2009}.

In PISM the SSA may be used as a ``sliding law'' for grounded ice which is otherwise modeled by the non-sliding SIA.  The resulting hybrid model is recommended for many purposes \cite{BBssasliding,BKAJS}.  This role for the SSA is in addition to its obvious role in ice shelf modeling.  In brief, our concept for grounded ice is that we must balance the membrane stresses which become important anywhere there is significant sliding.  These stresses are especially important near spatial (and temporal) changes in basal strength.  Similar concerns at the ``grounding line'', where ice flows into a floating ice shelf, also suggest that membrane stresses on the grounded side of the grounding line are worth including.

By default, PISM does not numerically solve the SSA because any such solution must go with a conscious user choice about basal strength.  The user must both use one of two options to turn on the SSA (section \ref{subsect:ssacontrol}) and also make choices in input files and runtime options about basal strength (section \ref{subsect:basestrength}).


\subsection{A hierarchy of simplifying assumptions for ice flow}\label{sec:model-hierarchy}\index{PISM!hierarchy of simplifying assumptions}   Table \ref{tab:modelhierarchy} describes a hierarchy of models which are implemented in PISM or are planned.  This hierarchy is listed in order of increasing effectiveness in modeling grounded ice sheets with fast flow features.  It is also listed in order of increasing need for data to serve as boundary and initial conditions, an important consideration for the scientific user.

\begin{table}[ht]
\caption{Hierarchy of current and planned flow models in PISM, for the grounded parts of ice sheets, from most to fewest simplifying assumptions \emph{and} from least to greatest need for boundary data.  The \emph{italicized} models are planned for future versions of PISM but are not implemented in \texttt{stable0.3}.}\label{tab:modelhierarchy} 
\small
\begin{tabular}{p{0.25\linewidth}p{0.35\linewidth}p{0.3\linewidth}}\hline
\textbf{Model} & \textbf{Assumptions [references]} & \textbf{Needed initial/boundary data} \\ \hline
\emph{perfectly-plastic ice} \tiny[planned]\small & \emph{steady state}; all points in the ice have shear stresses at or below a pre-determined ``yield stress'' & bed elevation, chosen location for margin \\
\emph{balance velocities} \tiny[planned]\small & \emph{steady state}; ice flows down surface gradient \cite{JoughinetalGrBal97} & surface mass balance, ice  thickness, bed elevation \\
\textsc{isothermal SIA} & non-sliding lubrication flow, fixed softness \cite{BLKCB,EISMINT96} & same, with time-dependence \\
\textsc{thermo-coupled SIA} & non-sliding lubrication flow, temperature-dependent softness \cite{BBL,EISMINT00} & same, plus surface temperature,  geothermal flux \\
\textsc{polythermal SIA} & same, but allowing liquid water in the temperate ice matrix and conserving energy more completely \cite{AschwandenBlatter,Greve} & same, plus surface liquid water fraction if available \\
\textsc{SIA + SSA hybrid} & SSA as a sliding law for thermo-coupled SIA \cite{BBssasliding} & same, plus basal layer (till) strength \\
\emph{Blatter-Pattyn} \tiny[planned]\small & ``higher-order'', bridging stresses \cite{Blatter,Pattyn03,SchoofCoulombBlatter} & same \\ \hline
\end{tabular}
\normalsize
\end{table}

As an additional row one might list ``full Stokes'' in Table \ref{tab:modelhierarchy}.  That stress balance is \emph{not} planned for PISM at any time, however, as its numerical solution requires a fundamentally different computational architecture.

It makes sense to also talk about an \emph{ice shelf} model hierarchy, and even about a special hierarchy of models for the transition from grounded to floating ice \cite{SchoofMarine1}, but this would take us too far afield.  Currently, ice shelves should always be modeled by the SSA equations in PISM.


\subsection{Evolutionary versus diagnostic ice shelf modeling} \label{subsect:basicmodes}\index{PISM!evolution run}\index{PISM!diagnostic run}    The main goal of a numerical ice sheet model like PISM is to be a dynamical system which evolves over time as similarly as possible to the modeled ice sheet.  Such a goal assumes one has the right climate inputs and parameter choices at each time step.  For predictive purposes, such a goal also assumes one starts with the right initial conditions, adequately describing the present state of the ice sheet.  (In fact this last assumption is rarely satisfied and heuristics must be used to minimally-initialize an ice sheet model, before a possible stage of paleo-climate driven spinup; see section \ref{sect:boot}.)

Underlying an ice sheet model like PISM are evolution-in-time partial differential equations.  PISM solves these by taking small time steps.  ``Small'' time steps vary from hundredths to many model years, depending primarily on both grid resolution and modeled ice flow speed.  Time steps are chosen adaptively in PISM, according to the stability criteria of the several numerical methods.  We will describe this usual time-stepping behavior as an ``evolution run.''

However, much ice flow modeling, especially of streams and shelves, uses only instantaneous ``diagnostic'' solution of the partial differential equations which determine the velocity field.  The existence of such ``instantaneous'' velocity fields follows from the slowness of the ice, which implies that inertia can be neglected in the stress balance \cite{Fowler}.  The goal of a ``diagnostic run'' is usually to compute the velocity field, including the instantaneous rate of surface movement in particular.  This will be our definition of ``diagnostic run'' from now on.  (Especially for grounded ice, making diagnostic runs may be the ``forward model'' step in inverting surface velocities for basal strength.  But again that would take us far afield.)

Sections \ref{sec:eismint-greenland} and \ref{sect:ross} are examples which illustrate the evolutionary and diagnostic modeling modes of PISM.  The first of these describes time-stepping evolution models for the Greenland ice sheet, while the second describes a diagnostic SSA model for the Ross ice shelf.

\subsection{Climate inputs and their separation from ice dynamics}
\label{sec:climate-inputs}  This section applies the seventh PISM organizing principle above (section \ref{sect:dynamics}): \emph{climate inputs affect ice dynamics by a well-defined interface}.

Because PISM's job is to approximate ice flow, its world view is centered around ice dynamics.  The boundary conditions required to model dynamics, and the corresponding interfaces, are necessarily ``ice-centric'' in our description here, but we believe there is no actual constraint on the nature of the other climate models which could be coupled to PISM.

Figure~\ref{fig:climate-inputs} is an illustration emphasizing that the ice sheet has a top surface interface (green dashed line in the figure) separating it from a surface processes (snow, firn, melt, runoff, \dots processes) layer.  This latter layer of modeled processes is assumed in PISM to cover the whole surface of the ice, including ablation areas, and even ice-free bedrock.

\begin{figure}
  \centering
  \includegraphics[width=5in]{figs/climate-cartoon-new.pdf}
  \caption{PISM's view of interfaces between an ice sheet and the outside world}
  \label{fig:climate-inputs}
\end{figure}

\begin{table}[h]
  \centering
  \begin{tabular}{p{0.35\linewidth}p{0.55\linewidth}}\\
    \hline
    \textbf{Boundary} & \textbf{Necessary conditions}\\
    \hline
    Top ice surface (below firn) (\textcolor{green}{green})& Ice temperature (or enthalpy) and mass flux into the ice\\
    Bottom surface of the thermal bed layer (not shown) & Geothermal flux\\
    Ice shelf basal surface (\textcolor{blue}{blue})& Mass flux into the ocean and ice boundary temperature\\
   \hline
  \end{tabular}
  \caption{Boundary conditions required by PISM's ice dynamics core; see figure
  \ref{fig:climate-inputs}}
  \label{tab:ice-dynamics-bc}
\end{table}

Regarding the base of the ice, as described in section \ref{subsect:beddef} PISM also includes an optional bed deformation component approximating the movement of the Earth's crust and upper mantle in response to changing ice load.   Furthermore the temperature of the layer of bedrock in contact with grounded ice is included in the conservation of energy model.  In this sense everything below the black dashed line (i.e.~ice and bedrock) is ``owned'' by PISM, which adds two more boundary interfaces for the ice dynamics core: sub-ice-shelf/ocean (shown in blue) and the bottom of the bedrock thermal layer (not shown).

Table \ref{tab:ice-dynamics-bc} lists boundary conditions required at
interfaces mentioned above.\footnote{This is a somewhat simplified view  corresponding to a ``generic'' PISM run.   See section \ref{sec:model-hierarchy} for details.}

The PISM ice dynamics core would like to be able to get these fields directly from observations or measurements, or directly from a GCM.  In many realistic modeling situations, however, PISM code must be used for all or part of the surface processes modeling necessary to provide the ice-dynamics core with the ``right'' fields.  Due to differences in model resolutions and required down-scaling, this need for some PISM-based boundary-processes modeling includes cases where PISM is coupled to a GCM.  In the kind of ``offline'' runs described in this \emph{Manual}, boundary processes are modeled, even if trivially.

Thus, in able to use the data that \emph{is} available, an ice-sheet model has to
have additional components that are responsible for modeling surface (snow)
processes or sub-shelf/ocean interaction.  These components might be very minimal, merely turning data that we already have into data in the right units and with the right metadata, so that PISM knows what to do with it, for example.

Thus we have PISM's design: the ice-dynamics-and-earth-deformation PISM
core does not contain any parameterization or other model for boundary mass or
energy balance.  These boundary parameterizations and models are present in the PISM source code, however, as instances of \emph{PISMComponent} classes.  This simplifies customizing and debugging PISM's climate
inputs, promotes code reuse.  It isolates the code that needs to be changed to
couple PISM to a climate model.

Users wishing to customize PISM's climate inputs should see the \emph{PISM
  Source Browser}, e.g.~at
\url{http://www.pism-docs.org/dev/doxy/html/index.html} and the documentation
of \emph{PISMSurfaceModel}, \emph{PISMAtmosphereModel} and
\emph{PISMOceanModel} therein.  Also, section \ref{sec:eismint-greenland} describes a
modeling example using a non-standard air temperature parameterization. Looking
at \texttt{pgrn.cc} and \texttt{pgrn_atmosphere.cc} may be a reasonable
start.

Note that figure~\ref{fig:climate-inputs} includes an interface that was not
mentioned yet, the one between the surface layer and the air (red dashed line).
Unlike the ones listed in table~\ref{tab:ice-dynamics-bc}, this interface
\emph{may not even be present in some PISM configurations:} the ice dynamics
core of PISM only ``knows'' about mediums bordering ice and bedrock. A pair
consisting of a \emph{PISMSurfaceModel} and a \emph{PISMOceanModel} may be
hiding anything from a nearly trivial parameterization of ice surface
temperature plus surface and sub-shelf mass fluxes to a GCM of great
complexity.

Figure~\ref{fig:climate-input-data-flow} illustrates the corresponding data
flow \emph{into} the PISM core; the data flow in the other direction depends on
particular modeling choices.

This figure requires an explanation: a ``modifier'' in this context is an
adjustment of climate inputs that can be used with different climate
choices.  Using ice-core-derived air temperature offsets to model the space-time distribution of paleo surface temperature is an example.  Note that PISM has a generic ``forcing'' mechanism that can be paired with another model. Please see section \ref{sec:boundary-models} for
a list of climate components included in PISM source code and other details.

\begin{figure}
  \centering
  \includegraphics[width=5in]{figs/data-flow.pdf}
  \caption{PISM climate input data flow. Colored arrows correspond to interfaces in
    figure \ref{fig:climate-inputs}.}
  \label{fig:climate-input-data-flow}
\end{figure}

Why describe this structure here? On the one hand, some users may be interested
in coupling PISM to other models. On the other hand, the PISM authors do not
claim expertise in modeling atmosphere, ocean, or even snow processes.   So the
separation has a code-reliability purpose. Indeed PISM users need to know that
they are ultimately responsible for providing the climate inputs they intend.
The auxiliary tool \texttt{pclimate}, described in subsection
\ref{subsect:pclimate}, is intended to help users observe the climate inputs
they have chosen, without involving ice dynamics at all.

\clearpage
\newpage
\section{Initialization and bootstrapping}\label{sect:boot}  

\subsection{``Initialization from a saved model state''}  This phrase\index{initialization!from saved model state} has a simple meaning in PISM.  If a previous PISM run has saved a NetCDF file using ``\texttt{-o}'' then that file will contain complete initial conditions for continuing the run.  The output file from the last run can be loaded with ``\texttt{i}'':\index{pisms}

\begin{verbatim}
$ pisms -eisII A -y 100 -o foo.nc
$ pisms -eisII A -i foo.nc -y 100 -o bar.nc
\end{verbatim}
\smallskip

Note that simplified-geometry experiments (section \ref{sect:simp}) and verification tests (section \ref{sect:verif}) do not need input files at all because they initialize from formulas in the source code.  They can be continued from saved model states using \texttt{-i}.  As in the above example, however, specifying the simplified geometry experiment or verification test \emph{is} necessary, so that the run can continue with the climate inputs for that experiment or test.  For example, based on the above \verb|pisms| runs, it is valid to do ``\verb|$ pismr -i foo.nc -y 100 -o bar.nc|'' but the climate and other parameters us PISM default values, and thus are not (necessarily) the values specified in EISMINT II.

As a technical but important note about saved states, a PISM run with \texttt{-ssa_floating_only} or \texttt{-ssa_sliding}
also saves the last SSA velocities to the output file, in variables 
\texttt{ubar_ssa} and \texttt{vbar_ssa}.  A \texttt{ssa_velocities_are_valid} global
attribute shows if the data present in these variables is valid.  The presence
of these velocities adds efficiency in restarting.  If you want a PISM restart to
ignore these velocities use \texttt{-dontreadSSAvels}.

\subsubsection*{\texttt{-i} file format}
PISM produces CF-1.4 compliant NetCDF\index{PISM!NetCDF file format}\index{NetCDF} files.  The easiest way to learn the output format \emph{and} the \texttt{-i} format is to do a simple run and then look at the metadata in the resulting file, like this:
\begin{verbatim}
$ pisms -eisII A -y 10 -o foo.nc
$ ncdump -h foo.nc | less
\end{verbatim}

Note that variables have a \texttt{pism_intent}\index{PISM!\texttt{pism_intent} attribute} attribute.  When that attribute is \texttt{diagnostic}, the variable can be deleted from the file without affecting whether PISM can use it as a \texttt{-i} input file.  Variables with \texttt{pism_intent} = \texttt{model_state}, by contrast, must be present for use with \texttt{-i}.

Regarding the automatically produced time variable, which has a \texttt{units} attribute like \texttt{"years since 1-1-1"}, note that CF metadata conventions require using a reference date in the units string of a time (\texttt{t}) variable.  PISM completely ignores this reference date.


\subsection{``Bootstrapping''} 
\optsection{Bootstrapping}
\optseealso{Grid}

This phrase\index{bootstrapping}\index{initialization!by bootstrapping} means starting a modeling run with less than sufficient data, and letting the model fill in needed values according to heuristics.  These heuristics are applied before the first time step is taken, so they are part of an initialization process.  Bootstrapping uses the option \fileopt{boot_from}.

The need for an identified stage like ``bootstrapping'' comes from the fact that initial conditions, for the evolution equations describing an ice sheet, are not typically observable.  As a principal example of this problem, these equations require the temperature within the ice at the time the run is started.  Glaciological observations, specifically remote-sensed observations which cover a large fraction or all of an ice sheet, never include this temperature field in practice.

Instead, evolutionary ice sheet modeling necessarily does something like this to get ``reasonable'' initial fields within the ice: \begin{enumerate}
\item start only with observable quantities like surface elevation, ice thickness, and ice surface temperature,
\item ``bootstrap'' as defined here, using heuristics to fill in temperatures at depth and to give a preliminary estimate of the basal sliding condition, and thus of the three-dimensional velocity field, and
\item \emph{either} do a long run holding the current geometry and surface temperature steady,  to evolve toward a ``more physical'' steady state which will have compatible temperature field, velocities, and age field,
\item \emph{or} do a long run using an additional spatially-imprecise historical record from an ice core or a sea bed core (or both), to apply forcing to the surface temperature or sea level (for instance), but with the same functional result of filling in a temperature, velocity, and age.
\end{enumerate}

The heuristics used by PISM are, for now, only documented in the source code file \texttt{src/base/iMbootstrap.cc}.

When using \fileopt{boot_from} you will need to specify both grid dimensions (using \t{Mx}, \t{My} and \t{Mz}) and the height of the computational box for the ice with \t{Lz}.  The data read from the file can determine the horizontal extent of the model, if options \t{Lx}, \t{Ly} are not set.  The additional specification of vertical extent by \texttt{-Lz} is reasonably natural because realistic data used in ``bootstrapping'' are two-dimensional.  Not specifying all four options \texttt{-Mx}, \texttt{-My}, \texttt{-Mz}, \texttt{-Lz} \emph{when bootstrapping with} \texttt{-boot_from} is an error.

Subsection \ref{sec:eismint-greenland} shows bootstrapping for the EISMINT-Greenland intercomparison.

\subsubsection*{\texttt{-boot_from} file format}
\label{sec:bootstrapping-format}  Allowed formats for a bootstrapping file are relatively simple to describe. 
\begin{enumerate}
\item The NetCDF dimensions \texttt{x} and \texttt{y} and corresponding variables must be present and have the meanings of projection X coordinate and projection Y coordinate.
\item Coordinate variables \texttt{x} and \texttt{y} have to be strictly increasing.
\item All three-dimensional variables (depending on \texttt{x,y,z} or \texttt{x,y,zb}) will be ignored in bootstrapping.
\item The \texttt{standard_name} attribute is used to identify a variable, so the names of variables do not need to match the corresponding variables in a PISM output file.
\item PISM expects all the input fields (NetCDF variables) to be in MKS \emph{or} to have the units specified using the \texttt{units} attribute.  PISM uses a library called UDUNITS\index{PISM!uses UDUNITS when reading NetCDF files}\index{UDUNITS} to convert data present in an input file to MKS.   This means that having ice thickness in feet or kilometers, or temperature in Celsius for example, is allowed.
\item Any two-dimensional variable (depending on \texttt{x,y}) may be missing.  For those missing variables some heuristic will be applied.  See table \ref{tab:modelhierarchy} for a sketch of the data necessary for bootstrapping, and \texttt{src/base/iMbootstrap.cc} for all further details.
\item Surface elevation is ignored if present.  Users with surface elevation and bed elevation data should produce an ice thickness variable, with \texttt{standard_name} = \texttt{land_ice_thickness} for bootstrapping.  The bed elevation (topography) is read by \texttt{standard_name} = \texttt{bedrock_altitude}.
\end{enumerate}

\subsection{For programmers deriving/modifying PISM:  Initialization sequence}  As described already, there are three ways to start PISM,\begin{itemize}
\item executables \texttt{pisms} and \texttt{pismv} initialize simplified-geometry experiments and verification tests, respectively, from formulas in the source code,
\item \texttt{-i} reads a previously-saved PISM model state in NetCDF form, and
\item \texttt{-boot_from} reads a NetCDF file and uses heuristics to fill in needed fields.
\end{itemize}
As a consequence of these options, and generally from the complexity of getting a computation started on a parallel computer, we observe that initializing PISM is one of the most error-prone parts of maintaining it.

Thus initialization sequence is also an error-prone part of writing a derived class of \texttt{IceModel} to modify PISM's function.  The reader interested in doing so should see method \texttt{IceModel::init()} and also view the flow chart in \texttt{doc/initialization-sequence.png}.  Note that \texttt{init()} is \emph{not} \texttt{virtual}.  Derived classes can redefine the several methods which are called by \texttt{init()}, which are \texttt{virtual}.


\clearpage\newpage
\input{modeling-choices.tex}

\clearpage\newpage
\input{practical-usage.tex}

\clearpage\newpage
\input{verification.tex}

\clearpage\newpage
\input{simplified-geometry.tex}

\clearpage\newpage
\input{eismint-greenland.tex}

\clearpage\newpage
\input{eismint-ross.tex}


%         References
\clearpage\newpage
\bibliography{ice-bib}
\bibliographystyle{siam}

\appendix

\newcommand{\subsect}[1]{\bigskip\subsection{#1}\rule{0mm}{2mm}\par\medskip}
%\newcommand{\subsectstar}[1]{\bigskip\subsection*{#1}\rule{0mm}{2mm}\par\medskip}
\newcommand{\subsectstar}[1]{\bigskip\noindent\textbf{#1.}\rule{0mm}{2mm}\par\medskip}
\newcommand{\subsubsect}[1]{\subsubsection{#1}\rule{0mm}{2mm}\par\smallskip}

\clearpage\newpage
\section{PISM command line options}\label{sect:options}

As PISM is a PETSc program \cite{petsc-user-ref}, all PETSc options are available as well.  The last subsection \ref{subsect:petscoptions} recalls some of these PETSc options.

The Index on page \pageref{sect:index} contains an alphabetical list of options.

\optsection{Old option index}
\subsect{List of PISM options}

\subsectstar{Options turning on and off major physical models}

\opt{float_kill}  If ice is (or becomes) floating then it is set to thickness zero.  This is calving at the grounding line.

\opt{hold_tauc}    Keep the current values of the till yield stress $\tau_c$.  That is, do not update them by the default model using the stored basal melt water.  Only effective if \texttt{-ssa} and \texttt{-plastic} are also set.  See documentation of option \texttt{-plastic} for a description of the till yield stress model.

\opt{no_mass}  Forces PISM to not change the ice thickness.  No time steps of the mass conservation equation are computed.

\opt{no_temp}  Force PISM to not change temperature or age values within the ice.  No time steps of the energy conservation and age equations are computed.

\opt{ocean_kill}  If used with input from a NetCDF initialization file which has ice-free ocean mask (value \texttt{MASK_FLOATING_OCEAN0}$=7$), will zero out ice thicknesses in areas that were ice-free ocean at time zero.  This is calving at the location of the original calving front.  Has no effect when used in conjunction with \texttt{-no_mass}.

\opt{ssa}  Use the equations of the shallow shelf approximation \cite{MacAyeal,Morland,SchoofStream,WeisGreveHutter} for ice shelves and dragging ice shelves (i.e.~ice streams) where so-indicated by the mask.  To view the mask use \texttt{-view_map mask}.  See also \texttt{-plastic} and \texttt{-super}. See also \texttt{-dontreadSSAvels}.

\opt{super}  Combine the velocity fields from the SIA and SSA models as in \cite{BBssasliding}.  Only effective if used with \texttt{-ssa}.

\subsectstar{Options controlling numerical methods}

\subsubsect{General methods}

\opt{eta}  The surface gradient is usually computed in the obvious way by finite differences applied to the surface elevation $h$.  Specifically, we use the Mahaffy \cite{Mahaffy} scheme.  Alternatively, if this option is set we first transform the thickness $H$ by $\eta = H^{(2n+2)/n}$ and then differentiating the sum of the thickness and the bed:
	$$\grad h = \grad H + \grad b = \frac{n}{(2n+2)} \eta^{(-n-2)/(2n+2)} \nabla \eta + \nabla b.$$
Here $b$ is the bed elevation and $h$ is the surface elevation.  The transformation sometimes has the benefits that the surface values of the horizontal velocity and vertical velocity, and the driving stress, are better behaved near the margin.  See \cite{CDDSV} for the technical explanation of this transformation and compare \cite{SaitoMargin}.

\optdef{low_temp}{200.0}  Set the temperature which PISM will regard as ``too low''.  Units in Kelvin.  Note that one kind of numerical error associated to the advection part of the conservation of energy scheme is for the maximum principle to be violated.  In that case temperatures appear at the next step which are outside the range of current temperatures.  PISM attempts to count such violations, and if the number is too great then the run is stopped.  See option \texttt{-max_low_temps}.

\optdef{max_low_temps}{10}  Specify the number (a nonnegative integer) of allowed low temp violations per time step.  Note these are reported in detail (i.e.~with location) if \texttt{-verbose} is set.  Note that one kind of numerical error associated to the advection part of the conservation of energy scheme is for the maximum principle to be violated.  In that case temperatures appear at the next step which are outside the range of current temperatures.  PISM attempts to count such violations, and if the number is too great then the run is stopped.  See option \texttt{-low_temp} for the cutoff low temperature.

% FIXME: describe the pross driver.
% \optrestrict{ross}{pismd}    Run the EISMINT Ross ice shelf validation \cite{MacAyealetal}.  Requires data from \url{http://homepages.vub.ac.be/~phuybrec/eismint/iceshelf.html}.


\subsect{PETSC options for PISM users}\label{subsect:petscoptions}

All PETSc programs accept command line options which control how PETSc distributes jobs among parallel processors, how it solves linear systems, what additional information it provides, and so on.  The PETSc manual \cite{petsc-user-ref} is the complete reference on these options.  We list some here that are useful to PISM users.  They can be mixed in any order with PISM options.

Both for PISM and PETSc options, there are ways of avoiding the inconvenience of long commands with many runtime options.  Obviously, and as illustrated by examples in the previous sections, shell scripts can be set up to run PISM.  But PETSc also provides two mechanisms to give runtime options without retyping at each run command.

First, the environment variable \texttt{PETSC_OPTIONS} can be set.  For example, a sequence of runs might need the same refined grid, and you might want to know if other options are read, ignored, or misspelled.  Set (in bash):

\texttt{export PETSC_OPTIONS="-Mx 101 -My 101 -Mz 51 -options_left"}

\noindent The runs 
\begin{verbatim}
$ pismv -test F -y 100
$ pismv -test G -y 100
\end{verbatim}
\noindent then have the same refined grid in each run, and the runs report on which options were read.

Second, the file \texttt{.petscrc} is always read, if present, from the directory where PISM (i.e.~the PETSc program) is started.  It can have a list of options, one per line.  For example, to get the same options as above, \texttt{.petscrc} would contain these lines:
\begin{verbatim}
-Mx 101
-My 101
-Mz 51
-options_left
\end{verbatim}
\noindent Note that the first four lines give PISM options while the last has a generic PETSc option.

These two PETSc mechanisms can be used together.  (The effect of duplicate or conflicting options is not clear, however, and should be avoided.)
\bigskip

% "-da_processors_x M -da_processors_y N" should not be documented in this sub-appendix
% because they do not work.  the reason is that IceModelVec2 and IceModelVec3 put 
% the Mx, My dimensions in different arguments to the DACreate commands


\optdef{ksp_rtol}{1e-5}  For solving the SSA equations with high resolution on multiple processors, it is recommended that this be tightened (set lower than the default).  For example, 

\verb|$  mpiexec -n 8 pismv -test I -Mx 5 -My 769|

\noindent works poorly on a certain machine, but

\verb|$  mpiexec -n 8 pismv -test I -Mx 5 -My 769 -ksp_rtol 1e-10|

\noindent works fine.

\optdef{ksp_type}{gmres}  Based on one processor evidence from \texttt{pismv -test I}, the following are possible choices in the sense that they work and allow convergence at some reasonable rate: \t{cg}, \t{bicg}, \t{gmres}, \t{bcgs}, \t{cgs}, \t{tfqmr}, \t{tcqmr}, and \t{cr}.  It appears \t{bicg}, \t{gmres}, \t{bcgs}, and \t{tfqmr}, at least, are all among the best.



\optdef{pc_type}{ilu}   Several options are possible, but for solving the ice stream and shelf equations we recommend only \t{bjacobi}, \t{ilu}, and \t{asm}.  Of these it is not currently clear which is fastest; they are all about the same for \texttt{pismv -test I} with high tolerances (e.g.~\texttt{-ssa_rtol 1e-7} \texttt{-ksp_rtol 1e-12}).




\phantomsection
\addcontentsline{toc}{section}{General Index}
\label{sect:index}
\printindex

\phantomsection
\addcontentsline{toc}{section}{PISM Command-line options}
\printindex[options]


\end{document}
