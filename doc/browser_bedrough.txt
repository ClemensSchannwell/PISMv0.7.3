/*! \page bedrough Using Schoof's bed-roughness-effect technique in PISM

PISM stable0.3 (i.e.~early 2010) is not as fast as we want.  This is especially noticable for rough beds, though there is no reason to believe that the physical model is doing something wrong.  We observe, in particular, that if the bed elevation \c topg is smoothed by preprocessing then the peak values of the SIA diffusivities, and also the peak magnitudes of horizontal velocities, from both the SIA and SSA models, are reduced.  The consequence of this reduction, through the adaptive time-stepping mechanism, is that PISM can take longer time steps and thus that it can complete model runs in shorter time.

This effect is noticable, and significant, when:
- using the <A HREF="http://www.pism-docs.org/wiki/doku.php?id=worked-searise-greenland">SeaRISE-Greenland present-day data, including recent CReSIS radar data, on 5km and finer grid resolution runs</A>, and
- using the <A HREF="http://www.pism-docs.org/wiki/doku.php?id=worked-searise-antarctica-uaf">SeaRISE-Antarctica data on 10km grid resolution runs</A>.

The peak diffusivities, which cause much shorter time-steps, occur generically at margin locations where the ice is on, or has flowed into, fjord-like bedrock topography.  At coarser resolutions (%e.g. 20km and up), it appears that the effect of increasing bed roughness is not as severe as at finer resolutions ((%e.g. 10km, 5km and finer).  Of course the shallow models we use (SIA and SSA) are missing significant stress gradients at the same margin locations which have large bed slopes.

But there is a theory which addresses \e exactly this situation for the SIA model, and explains that one can use a smoothed bed if one also \e lowers the SIA diffusivity.  This theory both explains how to improve the SIA model to handle bed roughness more correctly, \e and it explains how to get a double performance boost:
- smoothed beds give longer time steps in PISM directly, and
- the theory explains that the effect of the local bed roughness is to further reduce the diffusivity, and thus get even longer time-steps.

How could we have missed this theory until now?  It is in the paper, C.Schoof (2003) [<i>The effect of basal topography on ice sheet dynamics</i>; \ref Schoofbasaltopg2003].  Schoof's main idea is to expand the Stokes equations in two levels of horizontal scales, one for the entire ice sheet (denoted \f$[L]\f$) and one for the wavelength of "typical" bed features (\f$[S]\f$).  The "inner" scaling assumes that the typical depth \f$[D]\f$ is small compared to \f$[S]\f$, while the "outer" scaling assumes that \f$[S]\f$ is small compared to \f$[L]\f$
	\f[\nu = \frac{[D]}{[S]} \ll 1, \qquad \delta = \frac{[S]}{[L]} \ll 1.  \f]
Specifically, there is an "inner" horizontal variable \f$x\f$ describing the local topography on scales comparable to \f$[S]\f$ or smaller, and an "outer" horizontal variable \f$X\f$ describing the large scale bed topography and ice sheet flow as a whole on scales larger than \f$[S]\f$.

In order to describe the Schoof scheme, we use PISM notation and start by stating the SIA mass continuity equation:
  \f[ \frac{\partial H}{\partial t} = (M - S) - \nabla\cdot \mathbf{q}. \f]
(Recall that \f$M-S\f$ is the mass balance added to the ice column per time.  It plays no further role here.)  The horizontal mass flux
  \f[ \mathbf{q} = - D \nabla h \f]
in the case of no basal sliding, so the mass continuity equation is \e diffusive.  The diffusivity is a function of the ice geometry and the ice flow law.  In the isothermal Glen power law (power \f$= n\f$) case we recall
  \f[ D = \Gamma H^{n+2} |\nabla h|^{n-1}, \f]
where \f$\Gamma = 2 A (\rho g)^n / (n+2)\f$ and \f$A\f$ is the ice softness [\ref BLKCB].  We will use \f$x_1,x_2\f$ to denote the horizontal model coordinates, though they are denoted \f$=x,y\f$ elsewhere in these PISM docs, and we note that \f$D\f$ is a nonnegative function: \f$D(t,x_1,x_2) \ge \f$.

Consider a locally-smoothed bed, computed by averaging the original bed topography \f$b_0(x_1,x_2)\f$ over a rectangular region of sides \f$\lambda_1\f$, \f$\lambda_2\f$, respectively:
  \f[ b_s(x_1,x_2) = \fint b_0(x_1+\xi_1,x_2+\xi_2)\,d\xi_1\,d\xi_2  \f]
where the slashed integral symbol is defined as
  \f[ \fint F(\xi_1,\xi_2)\,d\xi_1\,d\xi_2 = \frac{1}{4\lambda_1\lambda_2} \int_{-\lambda_1}^{\lambda_2} \int_{-\lambda_1}^{\lambda_2} F(\xi_1,\xi_2)\,d\xi_1\,d\xi_2. \f]
(Note that we assume for the moment that the bed is independent of time, but that this restriction is removed below.)  Consider also the "local bed topography"
  \f[ \tilde b(x_1,x2,\xi_1,\xi_2) = b_0(x_1+\xi_1,x_2+\xi_2) - b_s(x_1,x_2). \f]
That is, as a function of the local coordinates \f$-\lambda_1 \le \xi_1 \le \lambda_1\f$, \f$-\lambda_2 \le \xi_2 \le \lambda_2\f$, the local bed topography \f$\tilde b\f$ is the amount by which the bed deviates from the "local average" \f$b_s(x_1,x_2)\f$.  Finally, it is important to note that in the current discussion the ice thickness and ice surface elevation are related to the \e smoothed bed topography in our notation,
  \f[ H(t,x_1,x_2) = h(t,x_1,x_2) -b_s(x_1,x_2). \f]

Now, Schoof [\ref Schoofbasaltopg2003, equation (49)] modifies the diffusivity by multiplying by a factor \f$0 \le \theta \le 1\f$:
  \f[ \tilde D = \theta(H(x_1,x_2),x_1,x_2) \, D. \f]
By definition,
  \f[ \theta(H,x_1,x_2) = \left[ \fint \left(1 - \frac{\tilde b(x_1,x2,\xi_1,\xi_2)}{H}\right)^{1/n}\,d\xi_1\,d\xi_2 \right]^{-n}  \f]
The formula is more complex if there is basal sliding.  The very important fact that \f$0 \le \theta \le 1\f$ is proven in appendix A of [\ref Schoofbasaltopg2003].

Actually, the above formulas reflect the way Schoof recommends how to apply his formulas [\ref Schoofbasaltopg2003, subsection 4.2].  In fact his averages are limits,
  \f[ \lim_{R\to\infty} \frac{1}{2R} \int_{-R}^R f(\xi,x)\,d\xi \f]
and so on.  But Schoof specifically recommends averaging over some finite length scale which should be "considerably greater than the grid spacing, but much smaller than the size of the ice sheet."  Furthermore he recommends that, because of the typical aspect ratio of ice sheets, "Bed topography on much larger length scales than 10 km should then be resolved explicitly through the smoothed bed height [\f$b_s\f$] rather than the correction factor \f$\theta\f$."  Thus we will use \f$\lambda_1 = \lambda_2 = 10\f$ km as the default, but naturally allow non-default values (including zero, perhaps, which could be a sign to turn off this mechanism).



see IceModel::massContExplicitStep() and IceModel::velocitySIAStaggered()


It is, of course, possible to have bed roughness of major magnitude at essentially any wavelength.  But there is no claim that PISM ice flow models can handle \e any geometry.  Indeed the goal right now is to improve on the existing shallow models (SIA and/or SSA) while maintaining or increasing high-resolution performance and comprehensive model quality, including many other modeled physical processes including ice thermal state, basal lubrication, and so on.  The desirable properties of the [\ref Schoofbasaltopg2003] scheme are accepted not because the resulting model is perfect, but because there is both a physical modeling improvement \e and a computational performance improvement from its use.



The rest of this note [WILL] explain how this intellectual technology [CAN BE] implemented in PISM.


*/  /* <--- IF THIS END-OF-COMMENT IS LOST, CONFUSION RESULTS ... */









